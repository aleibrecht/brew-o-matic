(function(){var index=angular.module("index",["ngResource","ngRoute","ngSanitize","ngAnimate","data","resources","helper","login","comments","googlechart","calculator","device","brew-o-module.controller","notification","abm","gt.abm","admin","ui.bootstrap","alerts","settings","water","env","observer","print","gt.listview"]);index.config(["$routeProvider",function($routeProvider){$routeProvider.when("/recipe",{templateUrl:"partial/recipe-list.html",controller:"RecipeListCtrl"}).when("/collaborated",
{templateUrl:"partial/recipe-collaborated.html",controller:"RecipeCollaboratedCtrl"}).when("/favorites",{templateUrl:"partial/recipe-favorite.html",controller:"RecipeFavoriteCtrl"}).when("/public",{templateUrl:"partial/recipe-public.html",controller:"RecipePublicCtrl"}).when("/home/:userId",{templateUrl:"partial/user/home.html",controller:"HomeCtrl"}).when("/recipe/edit/:recipeId",{templateUrl:"partial/recipe-detail.html",controller:"RecipeDetailCtrl"}).when("/recipe/clone/:recipeId",{templateUrl:"partial/recipe-detail.html",
controller:"RecipeDetailCtrl"}).when("/recipe/new",{templateUrl:"partial/recipe-detail.html",controller:"RecipeDetailCtrl"}).when("/settings/water",{templateUrl:"partial/user/user-settings-water.html",controller:"SettingsWaterCtrl"}).when("/settings/water/new",{templateUrl:"partial/user/settings/user-settings-water-detail.html",controller:"SettingsWaterDetailCtrl"}).when("/settings/water/:waterId",{templateUrl:"partial/user/settings/user-settings-water-detail.html",controller:"SettingsWaterDetailCtrl"}).when("/settings",
{templateUrl:"partial/user/user-settings.html",controller:"UserSettingsCtrl"}).when("/settings/device",{templateUrl:"partial/device/device.html",controller:"DeviceController"}).when("/calculator",{templateUrl:"partial/calculator/calculator.html",controller:"CalculatorCtrl"}).when("/notification",{templateUrl:"partial/user/user-notification.html",controller:"NotificationsCtrl"}).when("/data/:entity",{templateUrl:"partial/data/abm.html",controller:"AbmCtrl"}).when("/admin/Stats",{templateUrl:"partial/admin/stats.html",
controller:"AdminCtrl"}).when("/admin/:entity",{templateUrl:"partial/admin/admin.html",controller:"AdminCtrl"}).otherwise({redirectTo:"/recipe"})}]);index.config(["abmProvider",function(abmProvider){abmProvider.setTemplateDir("template")}]);index.controller("HomeCtrl",function($scope,$rootScope,User,Recipe,$routeParams){$scope.$watch("user",function(){$scope.viewUser=User.get({id:$routeParams.userId},function(){$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:$scope.viewUser.name}]});
$scope.recipes=Recipe.findByUser({id:$routeParams.userId})});$scope.addFavorites=function(recipe){User.addToFavorites(recipe,function(user){$rootScope.user.favorites=user.favorites})};$scope.removeFavorites=function(recipe){User.removeFromFavorites(recipe,function(user){$rootScope.user.favorites=user.favorites})}});var notification=angular.module("notification",[]);notification.factory("notificationData",function(){return{listener:null,reset:function(){if(this.listener)this.listener()}}});notification.controller("NotificationsCtrl",
function($scope,Notification,$rootScope,notificationData){notificationData.reset();$scope.updateCount=function(notifications){$scope.countUnread=0;$scope.countNew=0;angular.forEach(notifications,function(not){if(not.status=="new")$scope.countNew++;else if(not.status=="unread")$scope.countUnread++})};$scope.$watch("user",function(){$scope.notifications=Notification.query($scope.updateCount)});$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Notificaciones"}];$scope.markAsRead=function(notification){if(notification.status!=
"read"){notification.status="read";notification.$save();$scope.updateCount($scope.notifications)}};$scope.statusClass=function(notification){if(notification.status=="unread")return"gt-notification-unread";else if(notification.status=="new")return"gt-notification-new";return""}});index.controller("MainController",function($scope,$rootScope,User){$rootScope.breadcrumbs=[];$scope.login=function(){googleSignIn()};var infos=[{text:"Si tenes 2 minutos, podes rellenar una encuesta sobre uso de Brew-o-Matic.",
link:{text:"Abrir Encuesta",href:"https://docs.google.com/forms/d/1lCObRGFtB2g3S3jiwwNweNUz5hRrLuyni2zFZz40R58/viewform"},id:"closeUseSurvey"}];$scope.infos=[];$scope.closeInfo=function(index){$scope.infos.splice(index,1)};$scope.closeForEver=function(info,index){$scope.user.settings[info.id]=true;User.updateSettings($scope.user,function(){$scope.infos.splice(index,1)})};$scope.$watch("user",function(user){if(user)for(var i=0;i<infos.length;i++)if(!user.settings[infos[i].id])$scope.infos.push(infos[i])})});
var alerts=angular.module("alerts",[]);alerts.factory("alertFactory",function($rootScope){var alerts=[];return{create:function(type,text,title){alerts=[];var a={type:type,text:text,title:title};alerts.push(a);setTimeout(function(){util.Arrays.remove(alerts,a);$rootScope.$apply()},5E3)},getAlerts:function(){return alerts}}});index.run(function($rootScope,version,$filter,$location,BrewCalc,env,color,alertFactory,BrewHelper,$templateCache){$rootScope.$templateCache=$templateCache;$rootScope.BrewCalc=
BrewCalc;$rootScope.BrewHelper=BrewHelper;$rootScope.version=version;$rootScope.env=env;$rootScope.color=color;$rootScope.getAlerts=function(){return alertFactory.getAlerts()};$rootScope.encodeName=function(name){return encodeURIComponent(name)};$rootScope.sharedUrl=function(_id){return"http://"+$location.host()+":"+$location.port()+"/share.html#/"+_id};$rootScope.formatDate=function(date){return util.formatDate(date,$filter("date"))}})})();(function(){var helper=angular.module("helper",[]);helper.directive("showTags",function($compile,TagColor){return{restrict:"EA",replace:true,scope:{tags:"&",removable:"@",itemClick:"&"},template:"<button style='margin:2px' ng-click='removeTag($index)' ng-repeat='tag in tags() track by $index' type='button' class='btn btn-xs' ng-class='color(tag)'>"+"{{tag}}"+"<span ng-show='removable' class='glyphicon glyphicon-remove'></span>"+"</button>",controller:function($scope){$scope.color=TagColor;$scope.removeTag=
function($index){if($scope.removable)$scope.tags().splice($index,1);else if($scope.itemClick)$scope.itemClick()($scope.tags()[$index])}}}});helper.filter("formatDate",function($filter){return function(date){return util.formatDate(date,$filter("date"))}});helper.factory("TagColor",function(){var colorsStyles=["btn-primary","btn-success","btn-yellow","btn-info","btn-warning","btn-danger","btn-brown"];var colorPos=0;var colorsTags={};return function(tag){if(colorsTags[tag])return colorsTags[tag];else{var ret=
colorsStyles[colorPos++];colorPos%=colorsStyles.length;colorsTags[tag]=ret;return ret}}});var ABV_COHEF=0.131;helper.factory("BrewCalc",function(BrewHelper){return{evapTotal:function(BOIL_TIME,EvapPerHour){var hours=Math.floor(BOIL_TIME/60);var rest=BOIL_TIME%60/60;var percentageEvap=1-rest*EvapPerHour/100;for(var i=0;i<hours;i++)percentageEvap*=1-EvapPerHour/100;return 1-percentageEvap},calculateBoilSize:function(BATCH_SIZE,TrubChillerLosses,BOIL_TIME,PercentEvap,TopUpWater){var ltsAfterBoil=BATCH_SIZE/
0.94+TrubChillerLosses;var percentageEvap=this.evapTotal(BOIL_TIME,PercentEvap);var tuw=TopUpWater?TopUpWater:0;return ltsAfterBoil/(1-percentageEvap)+tuw},initialMashVolume:function(StrikeWater,totalAmount){return StrikeWater+totalAmount},actualMashVolume:function($index,initVol,steps){var liters=initVol;for(var i=0;i<=$index;i++){var it=steps[i];if(it.infuse)liters+=it.INFUSE_AMOUNT}return liters},estimateLiters:function($index,BATCH_SIZE,stages){var liters=BATCH_SIZE;for(var i=0;i<$index;i++){var it=
stages[i];if(it.transferring)liters-=it.losses}return liters},bottledLiters:function(volumeByCarbonatationType,bottles){var liters=0;volumeByCarbonatationType.sugar=0;volumeByCarbonatationType.must=0;volumeByCarbonatationType.co2=0;angular.forEach(bottles,function(bottle){liters+=bottle.size*bottle.amount;volumeByCarbonatationType[bottle.carbonatationType]+=bottle.size*bottle.amount});return liters},fixEmptyValues:function(recipe){recipe.TrubChillerLosses=recipe.TrubChillerLosses||0;recipe.mashTemp=
recipe.mashTemp||66;recipe.GrainTemp=recipe.GrainTemp||25;recipe.SpargeTempDesired=recipe.SpargeTempDesired||75;recipe.SpargeDeadSpace=recipe.SpargeDeadSpace||0;recipe.lossMashTemp=recipe.lossMashTemp||0;recipe.PercentEvap=recipe.PercentEvap||10;if(!recipe.WatertoGrainRatio){recipe.WatertoGrainRatio=3;recipe.StrikeWater=BrewHelper.round(recipe.WatertoGrainRatio*recipe.totalAmount,10)}},totalCations:function(cations){if(!cations)return null;var B4=cations.calcium||0;var B5=cations.magnesium||0;var B6=
cations.sodium||0;var B7=cations.potassium||0;var B8=cations.iron||0;return B4/20.05+B5/12.15+B6/23+B7/39.1+B8/28},totalHardness:function(cations){if(!cations)return null;var B4=cations.calcium||0;var B5=cations.magnesium||0;return(B4/20.04+B5/12.15)*50},permanentHardness:function(water){if(!water)return null;return this.totalHardness(water.cations)-this.temporaryHardness(water)},temporaryHardness:function(water){if(!water)return null;return Math.min(this.totalHardness(water.cations),this.alkalinity(water.anions))},
alkalinity:function(anions){if(!anions)return null;var C4=anions.bicarbonate||0;var C5=anions.carbonate||0;return(C4+C5/0.6)*(50/61)*(1+2*Math.pow(10,-2.4))},effectiveHardness:function(cations){if(!cations)return null;var B4=cations.calcium||0;var B5=cations.magnesium||0;return(B4/20+B5/24.3)*50},residualAlkalinity:function(water){if(!water||!water.cations)return null;var B4=water.cations.calcium||0;var B5=water.cations.magnesium||0;return this.alkalinity(water.anions)-(B4*0.7143+B5*0.5879)},totalAnions:function(anions){if(!anions)return null;
var C4=anions.bicarbonate||0;var C5=anions.carbonate||0;var C6=anions.sulfate||0;var C7=anions.chloride||0;var C8=anions.nitrate||0;var C9=anions.nitrite||0;var C10=anions.fluoride||0;return C4/61+C5/30+C6/48+C7/35.45+C8/62+C9/46+C10/19},waterBalance:function(water){if(!water)return null;return Math.abs(this.totalAnions(water.anions)-this.totalCations(water.cations))},calculateABV:function(og,fg){var OG=BrewHelper.toPpg(og);var FG=BrewHelper.toPpg(fg);return BrewHelper.round((OG-FG)*ABV_COHEF,100)},
calculateOG:function(fg,abv){var FG=BrewHelper.toPpg(fg);var OG=abv/ABV_COHEF+FG;return BrewHelper.toPotential(OG)},calculateFG:function(og,abv){var OG=BrewHelper.toPpg(og);var FG=OG-abv/ABV_COHEF;return BrewHelper.toPotential(FG)},attenuation:function(og,fg){var OG=BrewHelper.toPpg(og);var FG=BrewHelper.toPpg(fg);return(OG-FG)/OG*100},toPlato:function(sg){return BrewHelper.round(-1*616.868+1111.14*sg-630.272*Math.pow(sg,2)+135.997*Math.pow(sg,3),100)},fromPlato:function(plato){var r=1+plato/(258.6-
plato/258.2*227.1);var result=BrewHelper.round(r,1E4);return result},adjustHydrometer:function(gravity,reading,calibration){return bfHydrometer.recalculate(gravity,reading,calibration)},adjustRefractometer:function(og,fg,correction){return bfRefractometer.recalculate(og,fg,correction)},dilution:function(currentGrav,currentVol,finalGrav){return bfDilution.recalculate(currentVol,currentGrav,finalGrav)}}});helper.factory("BrewHelper",function(){return{toLbs:function(kg){return kg/0.45359},toOz:function(kg){return kg*
1E3*0.035274},toGal:function(liters){return liters*0.264172052637296},toPpg:function(potential){return potential*1E3-1E3},toPotential:function(ppg){return this.round((ppg+1E3)/1E3,1E3)},round:function(value,zeros){return Math.round(value*zeros)/zeros},pad:function(value,zeros){return util.pad(value,zeros)},calculateU:function(gravity,time){var g=this.toPpg(gravity);var m=30;var M=120;for(var i=0;i<U_gravity.length;i++)if(g<U_gravity[i]){M=U_gravity[i];break}else m=U_gravity[i];var diff=M-m;var p=
(g-m)/diff;if(p==Infinity||isNaN(p))p=0;var valm;var valM;if(U[time.toString()]){valm=U[time.toString()][m.toString()];valM=U[time.toString()][M.toString()]}else{valm=0;valM=0}var valDiff=valM-valm;var valP=valDiff*p;return valm+valP},convertColor:function(srm){if(srm>40)return"black";else if(srm<1)return"white";else return SRM[Math.round(srm)]}}});var SRM=["#FFFFFF","FFE699","#FFD878","#FFCA5A","#FFBF42","#FBB123","#F8A600","#F39C00","#EA8F00","#E58500","#DE7C00","#D77200","#CF6900","#CB6200","#C35900",
"#BB5100","#B54C00","#B04500","#A63E00","#A13700","#9B3200","#952D00","#8E2900","#882300","#821E00","#7B1A00","#771900","#701400","#6A0E00","#660D00","#5E0B00","#5A0A02","#600903","#520907","#4C0505","#470606","#440607","#3F0708","#3B0607","#3A070B","#36080A"];var U_time=[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,90,100,110,120];var U_gravity=[30,40,50,60,70,80,90,100,110,120];var U={0:{30:0,40:0,50:0,60:0,70:0,80:0,90:0,100:0,110:0,120:0},5:{30:0.055,40:0.05,50:0.046,60:0.042,70:0.038,80:0.035,
90:0.032,100:0.029,110:0.027,120:0.025},10:{30:0.1,40:0.091,50:0.084,60:0.076,70:0.07,80:0.064,90:0.058,100:0.053,110:0.049,120:0.045},15:{30:0.137,40:0.125,50:0.114,60:0.105,70:0.096,80:0.087,90:0.08,100:0.073,110:0.067,120:0.061},20:{30:0.167,40:0.153,50:0.14,60:0.128,70:0.117,80:0.107,90:0.098,100:0.089,110:0.081,120:0.074},25:{30:0.192,40:0.175,50:0.16,60:0.147,70:0.134,80:0.122,90:0.112,100:0.102,110:0.094,120:0.085},30:{30:0.212,40:0.194,50:0.177,60:0.162,70:0.148,80:0.135,90:0.124,100:0.113,
110:0.103,120:0.094},35:{30:0.229,40:0.209,50:0.191,60:0.175,70:0.16,80:0.146,90:0.133,100:0.122,110:0.111,120:0.102},40:{30:0.242,40:0.221,50:0.202,60:0.185,70:0.169,80:0.155,90:0.141,100:0.129,110:0.118,120:0.108},45:{30:0.253,40:0.232,50:0.212,60:0.194,70:0.177,80:0.162,90:0.148,100:0.135,110:0.123,120:0.113},50:{30:0.263,40:0.24,50:0.219,60:0.2,70:0.183,80:0.168,90:0.153,100:0.14,110:0.128,120:0.117},55:{30:0.27,40:0.247,50:0.226,60:0.206,70:0.188,80:0.172,90:0.157,100:0.144,110:0.132,120:0.12},
60:{30:0.276,40:0.252,50:0.231,60:0.211,70:0.193,80:0.176,90:0.161,100:0.147,110:0.135,120:0.123},65:{30:0.28049999999999997,40:0.2565,50:0.2345,60:0.2145,70:0.196,80:0.179,90:0.1635,100:0.1495,110:0.137,120:0.125},70:{30:0.285,40:0.261,50:0.238,60:0.218,70:0.199,80:0.182,90:0.166,100:0.152,110:0.139,120:0.127},75:{30:0.288,40:0.2635,50:0.2405,60:0.22,70:0.201,80:0.184,90:0.168,100:0.1535,110:0.1405,120:0.1285},80:{30:0.291,40:0.266,50:0.243,60:0.222,70:0.203,80:0.186,90:0.17,100:0.155,110:0.142,
120:0.13},90:{30:0.295,40:0.27,50:0.247,60:0.226,70:0.206,80:0.188,90:0.172,100:0.157,110:0.144,120:0.132},100:{30:0.298,40:0.272,50:0.249,60:0.228,70:0.208,80:0.19,90:0.174,100:0.159,110:0.145,120:0.133},110:{30:0.3,40:0.274,50:0.251,60:0.229,70:0.209,80:0.191,90:0.175,100:0.16,110:0.146,120:0.134},120:{30:0.301,40:0.275,50:0.252,60:0.23,70:0.21,80:0.192,90:0.176,100:0.161,110:0.147,120:0.134}}})();(function(){var module=angular.module("brew-o-module.controller",[]);module.controller("RecipeMashCtrl",function($scope,BrewCalc,BrewHelper){$scope.styleTitle=function(onFocus){if(onFocus)return{background:"white","border-color":"#ccc"};else return{background:"white","border-color":"white",cursor:"pointer"}};$scope.moment=function($index){var time=0;for(var i=0;i<$index;i++)time+=$scope.recipe.MASH.MASH_STEPS.MASH_STEP[i].STEP_TIME;return time};$scope.totalTime=function(){var time=0;angular.forEach($scope.recipe.MASH.MASH_STEPS.MASH_STEP,
function(step){time+=step.STEP_TIME});return time};$scope.spargeWater=function(){return $scope.totalWater()-BrewCalc.actualMashVolume($scope.recipe.MASH.MASH_STEPS.MASH_STEP.length-1,0,$scope.recipe.MASH.MASH_STEPS.MASH_STEP)*2-$scope.recipe.StrikeWater-($scope.recipe.TopUpWater||0)};$scope.totalWater=function(){return BrewCalc.calculateBoilSize($scope.recipe.BATCH_SIZE,$scope.recipe.TrubChillerLosses,$scope.recipe.BOIL_TIME,$scope.recipe.PercentEvap,$scope.recipe.TopUpWater)+BrewCalc.actualMashVolume($scope.recipe.MASH.MASH_STEPS.MASH_STEP.length-
1,0,$scope.recipe.MASH.MASH_STEPS.MASH_STEP)+$scope.recipe.SpargeDeadSpace+$scope.recipe.GrainAbsorbtion*$scope.recipe.totalAmount};$scope.addWaterVol=function(STEP,$index){var ratio;if($index==0)ratio=$scope.recipe.WatertoGrainRatio;else{var vol=BrewCalc.actualMashVolume($index-1,$scope.recipe.StrikeWater,$scope.recipe.MASH.MASH_STEPS.MASH_STEP);ratio=vol/$scope.recipe.totalAmount}var botvol=0.7;STEP.INFUSE_AMOUNT=restCalc($scope.recipe.totalAmount,ratio,0,0,STEP.STEP_TEMP,STEP.END_TEMP,STEP.INFUSE_TEMP);
var volMash=BrewCalc.actualMashVolume($index-1,$scope.recipe.StrikeWater+$scope.recipe.totalAmount,$scope.recipe.MASH.MASH_STEPS.MASH_STEP);var decoctionTemp=100;STEP.DECOCTION_AMT=BrewHelper.round(volMash*(STEP.END_TEMP-STEP.STEP_TEMP)/(decoctionTemp-STEP.STEP_TEMP),10)};function restCalc(weight,thick,botvol,eqvol,curtemp,tartemp,boiltemp){var vol=weight*(0.417+thick)+botvol+eqvol;var watvol=vol*(tartemp-curtemp)/(boiltemp-tartemp);return BrewHelper.round(watvol,10)}$scope.strikeWaterTemp=function(){return($scope.recipe.mashTemp-
$scope.recipe.GrainTemp)*0.417/$scope.recipe.WatertoGrainRatio+$scope.recipe.mashTemp+$scope.recipe.lossMashTemp};$scope.changeAction=function(STEP,actionValue){if(actionValue=="0"){STEP.infuse=false;STEP.decoction=false}else if(actionValue=="1"){STEP.infuse=true;STEP.decoction=false}else if(actionValue=="2"){STEP.infuse=false;STEP.decoction=true}};$scope.stepAction=function(STEP){if(STEP.infuse)return"Agregar Agua";else if(STEP.decoction)return"Decoccion";return null};$scope.initActionValue=function(STEP){if(STEP.infuse)return"1";
else if(STEP.decoction)return"2";else return"0"};$scope.addMashStep=function(){var temp=$scope.recipe.mashTemp;angular.forEach($scope.recipe.MASH.MASH_STEPS.MASH_STEP,function(step){temp=step.END_TEMP});var ratio=$scope.recipe.WatertoGrainRatio;var recirculate=false;$scope.recipe.MASH.MASH_STEPS.MASH_STEP.push({NAME:null,TYPE:"Infusion",infuse:false,INFUSE_AMOUNT:0,INFUSE_TEMP:100,STEP_TIME:0,STEP_TEMP:temp,END_TEMP:temp,DESCRIPTION:null,WATER_GRAIN_RATIO:ratio,DECOCTION_AMT:0,recirculate:recirculate,
compact:false})};$scope.updateInfuse=function(){};$scope.calculateVolume=function(step_index){return BrewCalc.actualMashVolume(step_index,BrewCalc.initialMashVolume($scope.recipe.StrikeWater,$scope.recipe.totalAmount),$scope.recipe.MASH.MASH_STEPS.MASH_STEP)};$scope.updateChart=function(){};$scope.moveUp=function(STEP,$index){$scope.recipe.MASH.MASH_STEPS.MASH_STEP.splice($index,1);$scope.recipe.MASH.MASH_STEPS.MASH_STEP.splice($index-1,0,STEP)};$scope.moveDown=function(STEP,$index){$scope.recipe.MASH.MASH_STEPS.MASH_STEP.splice($index,
1);$scope.recipe.MASH.MASH_STEPS.MASH_STEP.splice($index+1,0,STEP)}});module.controller("BottlingCtrl",function($scope,Bottle,BrewHelper){$scope.bottleColor={"Ambar":"rgb(226, 137, 58)","Verde":"#348B29"};$scope.getBottleColor=function(colour){if(colour)return $scope.bottleColor[colour]||"#FFFFFF";else return"#FFFFFF"};$scope.bottles=Bottle.query();var sugarTypeCoef={cane:1,corn:0.87,honey:0.65};$scope.carbonatationStrategy={sugar:function(){if($scope.recipe.bottling.sugar){var volCO2=$scope.recipe.bottling.sugar.desiredVol;
var temp=$scope.recipe.bottling.sugar.temperature;if(!$scope.recipe.bottling.sugar.sugarType)$scope.recipe.bottling.sugar.sugarType="cane";var G11=9*temp/5+32;var H13=sugarTypeCoef[$scope.recipe.bottling.sugar.sugarType];$scope.restCO2=3.0378-0.050062*G11+2.655E-4*G11*G11;$scope.gramsLiter=BrewHelper.round((volCO2-$scope.restCO2)*4.23/H13,10)}}};$scope.changeBottles=function(){$scope.carbonatationStrategy.sugar()};$scope.carbonatationStrategy.sugar();$scope.changeBottleType=function(bottle){angular.forEach($scope.bottles,
function(it){if(it.name==bottle.bottleType){bottle.size=it.size;bottle.colour=it.colour;bottle.amount=$scope.round(bottle.subTotal/bottle.size)}});$scope.changeBottles()};$scope.obtainVolCO2Style=function(){var vol;$scope.titleForDesiredCO2="";angular.forEach($scope.styles,function(style){if(style.link&&$scope.recipe.STYLE.NAME==style.name)vol=BrewHelper.round(((style.co2_max||0)+(style.co2_min||0))/2,100)});if(vol){$scope.titleForDesiredCO2="Usar "+vol+" VOL ("+$scope.recipe.STYLE.NAME+")";$scope.disableObtainVolCO2=
false}else{$scope.titleForDesiredCO2="Vol de CO2 no conocido para el estilo";$scope.disableObtainVolCO2=true}return vol};$scope.obtainVolCO2Style();$scope.presureInPsi=function(vol,temp){var tempF=(212-32)/100*temp+32;var psi=BrewHelper.round(-16.6999-0.0101059*tempF+0.00116512*tempF*tempF+0.173354*tempF*vol+4.24267*vol-0.0684226*vol*vol,10);$scope.presureInBar=BrewHelper.round(Math.round(1/14.5038*psi*1E6)/1E6,100);$scope.presureKgCm2=BrewHelper.round($scope.presureInBar*1.01972,100);return psi};
$scope.obtainMaxFermTemp=function(carbonatationType){var max=0;angular.forEach($scope.recipe.fermentation.stages,function(stage){if(stage.temperature>max)max=stage.temperature;if(stage.temperatureEnd>max)max=stage.temperatureEnd});$scope.recipe.bottling[carbonatationType].temperature=max;$scope.changeBottles()};$scope.leftClass=function(value){var min=100;angular.forEach($scope.recipe.bottling.bottles,function(bottle){if(bottle.size<min)min=bottle.size});if(min==100)min=0;if(value>=min){$scope.restClass=
"text-info";$scope.restComment="Vamos! Aun podes seguir llenando mas botellas";return"gt-calculated"}else if(value>=0){$scope.restClass="text-warning";$scope.restComment="Ya usaste casi toda la cerveza, aun podes llenar una botella mas de "+min+" L a medias";return"gt-calculated"}else if(value>=-min){$scope.restClass="text-success";$scope.restComment="Ya has usado toda la cerveza, la ultima botella te ha quedado a medias";return"gt-green"}else{$scope.restClass="text-danger";$scope.restComment="Te has pasado!! no tienes tanta cerveza para llenar todas las botellas.";
return"gt-error"}};$scope.addBottle=function(){var rest=$scope.estimateLiters($scope.recipe.fermentation.stages.length)-$scope.bottledLiters();$scope.recipe.bottling.bottles.push({type:null,size:null,amount:0,subTotal:rest,carbonatationType:"sugar"});$scope.changeBottles()}});module.controller("RecipeBoilCtrl",function($scope,BrewHelper,BrewCalc){$scope.calculateSgBeforeBoil=function(BOIL_TIME,PercentEvap,OG){var percentageEvap=BrewCalc.evapTotal(BOIL_TIME,PercentEvap);return BrewHelper.toPotential(BrewHelper.toPpg(OG)*
(1-percentageEvap))}});module.controller("RecipeCollaboratorsCtrl",function($scope,User,alertFactory){$scope.users=User.query();$scope.removeUser=function(collaborator){util.Arrays.remove($scope.recipe.collaborators,collaborator)};$scope.addUser=function(user_id){var filter=function(item){return item._id==user_id?0:-1};var exists=util.Arrays.filter($scope.recipe.collaborators,filter).length!=0;if(exists){alertFactory.create("warning","El usuario seleccionado ya es un colaborador","Error al agregar usuario");
return}if($scope.recipe.owner&&user_id==$scope.recipe.owner._id||$scope.recipe.owner&&user_id==$scope.user._id){alertFactory.create("warning","No puede agregar al due\u00f1o de la receta como colaborador","Error al agregar usuario");return}var user=util.Arrays.filter($scope.users,filter)[0];$scope.recipe.collaborators.push(user)}});module.controller("RecipeRatingCtrl",function($scope,$http,$sce){$http.get("rating/beers").success(function(beers){console.log(beers);$scope.beers=beers});$scope.updateBeer=
function(){updateIFrame()};function updateIFrame(){if($scope.recipe.beer_id)$scope.iframeUrl=$sce.trustAsResourceUrl("http://www.birrasquehetomado.com.ar/html/tag.html#/beer/tag/"+$scope.recipe.beer_id)}updateIFrame()});module.controller("RecipeTabCtrl",function($scope){$scope.sortTabs=["main","mash","boil","fermentation","bottling","log","collaborators","rating","temperature"];$scope.tabs={main:{title:"Receta",template:"detail-main"},mash:{title:"Macerado",template:"mash"},boil:{title:"Hervido",
template:"boil"},fermentation:{title:"Fermentacion",template:"fermentation"},bottling:{title:"Embotellado",template:"bottling"},log:{title:"Bitacora",template:"log"},collaborators:{title:"Colaboradores",template:"collaborators"},rating:{title:"Calificaciones",template:"rating"},temperature:{title:"Temp. CEBADA",template:"temperature"}};$scope.selectedTab="main";$scope.changeTab=function(tab){$scope.selectedTab=tab;$scope.$parent.notifications=[]}});module.filter("ts2date",function(){return function(timestamp){return new Date(timestamp)}});
module.controller("RecipeTemperatureCtrl",function($scope,TempDeviceReport,pushListener){$scope.reload=function(){$scope.temperatures=TempDeviceReport.query({recipe_id:$scope.recipe._id},function(){$scope.updateChart()})};$scope.reload();function onNewTemperature(temp){$scope.temperatures.push(temp);$scope.updateChart();$scope.$apply()}pushListener.on("TEMP_DEVICE_REPORT_"+$scope.recipe._id,onNewTemperature);$scope.$on("$destroy",function(){pushListener.off("TEMP_DEVICE_REPORT_"+$scope.recipe._id,
onNewTemperature)});$scope.updateChart=function(){var cols=[{"id":"day","label":"Dias","type":"date"},{"id":"temp","label":"Temperatura","type":"number"}];var rows=[];angular.forEach($scope.temperatures,function(stage){rows.push({"c":[{"v":new Date(stage.timestamp)},{"v":stage.temperature|0,"f":(stage.temperature|0)+"\u00ba ("+stage.temperatureMax+")"}]})});$scope.chart.data.cols=cols;$scope.chart.data.rows=rows};$scope.chart={"type":"LineChart","displayed":true,"cssStyle":{height:"300px",width:"100%"},
"data":{"cols":[],"rows":[]},"options":{"title":"Evolucion","isStacked":"false","fill":20,"displayExactValues":true,"vAxis":{"title":"Temperatura","gridlines":{"count":10},minValue:0},"hAxis":{"title":"Dias"}},"formatters":{}}})})();(function(){var index=angular.module("index");index.filter("limitText",function(){return function(value,limit){if(value.length>limit)return value.substring(0,limit)+"...";else return value}});index.filter("filterFavorites",function(){return function(list,favorites){var ret=[];if(list&&list.length!=0&&favorites&&favorites.length!=0)angular.forEach(list,function(recipe){if(favorites.indexOf(recipe._id)!=-1)ret.push(recipe)});return ret}});index.controller("RecipeCollaboratedCtrl",function($scope,$rootScope,
Recipe,sortData){$scope.sort=sortData("NAME","");$scope.showTags=function(recipe){if(recipe.tags&&recipe.tags.length!=0){var txt="- Tags: ["+recipe.tags[0];for(var i=1;i<recipe.tags.length;i++)txt+=", "+recipe.tags[i];return txt+"]"}else return""};$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Colaboraciones"}];$rootScope.$watch("user",function(user){if(user){$scope.collaborated=Recipe.findCollaborated();$scope.stats=Recipe.stats()}})});index.controller("RecipeFavoriteCtrl",function($scope,
$rootScope,Recipe,User,sortData){$scope.sort=sortData("NAME","");$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Recetas Favoritas"}];$rootScope.$watch("user",function(user){if(user){$scope.published=Recipe.findPublic();$scope.stats=Recipe.stats()}});$scope.removeFavorites=function(recipe){User.removeFromFavorites(recipe,function(user){$rootScope.user.favorites=user.favorites})}});index.controller("RecipePublicCtrl",function($scope,$rootScope,$location,Recipe,User,sortData,Style,
Tag,PublishedRecipe,$templateCache){$scope.published=PublishedRecipe;$scope.sort={combo:[{label:"Fecha de publicacion",sort:"-publishDate"},{label:"Por nombre",sort:"NAME"},{label:"Por nombre descendente",sort:"-NAME"},{label:"Por estilo",sort:"STYLE.NAME"},{label:"Por estilo descendente",sort:"-STYLE.NAME"},{label:"Por DI",sort:"OG"},{label:"Por DI descendente",sort:"-OG"},{label:"Por % alc",sort:"ABV"},{label:"Por % alc descendente",sort:"-ABV"},{label:"Por IBU",sort:"CALCIBU"},{label:"Por IBU descendente",
sort:"-CALCIBU"},{label:"Por Litros",sort:"BATCH_SIZE"},{label:"Por Litros descendente",sort:"-BATCH_SIZE"}]};$scope.config={pageSize:10,filterOrder:["[STYLE.NAME]"],filterColSpan:6,plural:"Recetas",singular:"Receta",searchCriteriaLabel:"Buscar"};$templateCache.put("recipe-name.html",'<a ng-href="{{header.showUrl($model, header)}}">'+"{{$model.NAME}}"+"</a>"+'<show-tags item-click="header.filterByTag" tags="$model.tags"></show-tags>');$scope.headers=[{field:"NAME",caption:"Nombre",tooltip:"Nombre de la receta",
templateUrl:"recipe-name.html",filterByTag:function(tag){$scope.config.searchCriteria=tag},user:function(){return $scope.user},showUrl:function($model,header){if(!header.user())return"";if($model.owner._id==header.user()._id)return"#/recipe/edit/"+$model._id;else return $scope.sharedUrl($model._id)}},{field:"STYLE.NAME",caption:"Estilo"},{field:"OG",caption:"DI",tooltip:"Densidad inicial"},{field:"ABV",caption:"% alc",tooltip:"graduacion alcoholica"},{field:"CALCIBU",caption:"IBUs"},{field:"BATCH_SIZE",
caption:"Litros"},{field:"BREWER",caption:"Cervecero"},{field:"owner.name",caption:"Compartida por",template:'<a href="/#/home/{{$model.owner._id}}">'+"{{$model.owner.name}}"+"</a>"},{field:"publishDate",caption:"Fecha",template:'{{$model.publishDate | date:"dd-MM-yyyy HH:mm"}}'},{field:"clone",caption:"",template:'<a class="btn btn-default btn-xs" href="#/recipe/clone/{{header.encodeName($model._id)}}">'+"clonar"+"</a>",encodeName:$scope.encodeName}];$scope.filterData={};$scope.filterData["[STYLE.NAME]"]=
{caption:"Estilo",type:"combo",comparator:"equal",getLabel:function(value){return value.name},valueKey:"name",ignoreCase:false,data:Style.query(),orderBy:"name"};$scope.filterByTag=function(tag){console.log(tag)};$scope.reset=function(){angular.forEach($scope.filterData,function(val){delete val.value})};$rootScope.$watch("user",function(user){if(user)$scope.stats=Recipe.stats()});$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Recetas Publicadas"}];$scope.addFavorites=function(recipe){User.addToFavorites(recipe,
function(user){$rootScope.user.favorites=user.favorites})};$scope.removeFavorites=function(recipe){User.removeFromFavorites(recipe,function(user){$rootScope.user.favorites=user.favorites})};$scope.newTag="";$scope.addTag=function($event){if($event.keyCode==13){if(!$scope.filterData["tags"].value)$scope.filterData["tags"].value=[];if($scope.filterData["tags"].value.indexOf($scope.newTag)==-1)$scope.filterData["tags"].value.push($scope.newTag);$scope.newTag=""}}});index.controller("RecipeListCtrl",
function($scope,$rootScope,Recipe,Style,User,$location,$timeout,sortData,alertFactory,$templateCache){$scope.recipes=Recipe;$scope.sort={combo:[{label:"Codigo",sort:"-code"},{label:"Por nombre",sort:"NAME"},{label:"Por nombre descendente",sort:"-NAME"},{label:"Por estilo",sort:"STYLE.NAME"},{label:"Por estilo descendente",sort:"-STYLE.NAME"},{label:"Por DI",sort:"OG"},{label:"Por DI descendente",sort:"-OG"},{label:"Por % alc",sort:"ABV"},{label:"Por % alc descendente",sort:"-ABV"},{label:"Por IBU",
sort:"CALCIBU"},{label:"Por IBU descendente",sort:"-CALCIBU"},{label:"Por Litros",sort:"BATCH_SIZE"},{label:"Por Litros descendente",sort:"-BATCH_SIZE"}]};$scope.config={pageSize:10,filterOrder:["[STYLE.NAME]"],filterColSpan:6,plural:"Recetas",singular:"Receta",searchCriteriaLabel:"Buscar"};$templateCache.put("my-recipe-name.html",'<a ng-href="{{header.showUrl($model, header)}}">'+"{{$model.NAME}}"+"</a>"+'<show-tags item-click="header.filterByTag" tags="$model.tags"></show-tags>');$templateCache.put("recipe-code.html",
'<a ng-href="{{header.showUrl($model, header)}}">'+"{{$model.code}}"+"</a>");$templateCache.put("recipe-publish.html",'<a href="" ng-click="header.publish($model)" type="button" class="btn btn-success btn-xs" ng-hide="$model.isPublic" title="Compartir la receta con el resto de los cerveceros">'+'<span class="glyphicon glyphicon-cloud-upload"></span>'+"publicar"+"</a>"+'<span class="glyphicon glyphicon-check" title="Esta receta es publica, puede ser vista por todos los usuarios" ng-show="$model.isPublic"/>');
$templateCache.put("recipe-remove.html",'<button data-target="#{{header.confirmationID($model._id)}}" data-toggle="modal"  type="button" class="close" aria-hidden="true">&times;</button>'+'<div class="modal fade" id="{{header.confirmationID($model._id)}}" role="dialog" aria-labelledby="#label">'+'<div class="modal-dialog">'+'<div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'+'<h4 class="modal-title" id="label">Confirmacion</h4>'+
"</div>"+'<div class="modal-body">'+"\u00bfEsta seguro que desea eliminar la receta?"+"</div>"+'<div class="modal-footer">'+'<button type="button" class="btn" data-dismiss="modal">No</a>'+'<button type="button" ng-click="header.removeRecipe($model._id)" class="btn btn-primary" >'+"Si"+"</button >"+"</div>"+"</div>"+"</div>"+"</div>");$scope.headers=[{field:"code",caption:"#",tooltip:"Codigo de la preceta",templateUrl:"recipe-code.html",showUrl:function($model,header){return"#/recipe/edit/"+$model._id}},
{field:"NAME",caption:"Nombre",tooltip:"Nombre de la receta",templateUrl:"my-recipe-name.html",filterByTag:function(tag){$scope.config.searchCriteria=tag},user:function(){return $scope.user},showUrl:function($model,header){if(!header.user())return"";if($model.owner._id==header.user()._id)return"#/recipe/edit/"+$model._id;else return $scope.sharedUrl($model._id)}},{field:"STYLE.NAME",caption:"Estilo"},{field:"OG",caption:"DI",tooltip:"Densidad inicial"},{field:"ABV",caption:"% alc",tooltip:"graduacion alcoholica"},
{field:"CALCIBU",caption:"IBUs"},{field:"BATCH_SIZE",caption:"Litros"},{field:"BREWER",caption:"Cervecero"},{field:"clone",caption:"",template:'<a class="btn btn-default btn-xs" href="#/recipe/clone/{{header.encodeName($model._id)}}">'+"clonar"+"</a>",encodeName:$scope.encodeName},{field:"publish",caption:"",templateUrl:"recipe-publish.html",publish:function(recipe){recipe.$publish({isPublic:true},function(){alertFactory.create("success","La misma ya estara disponible para el resto de los usuarios!",
"Receta publicada con exito!")})}},{field:"remove",caption:"",templateUrl:"recipe-remove.html",confirmationID:function(id){return"confirmation"+id.replace("(","_").replace(")","_")},removeRecipe:function(_id){Recipe.remove({id:_id},function(){$("#"+$scope.confirmationID(_id)).modal("hide");$timeout(function(){$scope.recipes=$scope.config.control.refresh()},500)})}}];$scope.filterData={};$scope.filterData["[STYLE.NAME]"]={caption:"Estilo",type:"combo",comparator:"equal",getLabel:function(value){return value.name},
valueKey:"name",ignoreCase:false,data:Style.query(),orderBy:"name"};$scope.showTags=function(recipe){if(recipe.tags&&recipe.tags.length!=0){var txt="- Tags: ["+recipe.tags[0];for(var i=1;i<recipe.tags.length;i++)txt+=", "+recipe.tags[i];return txt+"]"}else return""};$rootScope.breadcrumbs=[{link:"#",title:"Home"}];$rootScope.$watch("user",function(user){if(user)$scope.stats=Recipe.stats()});$scope.confirmationID=function(id){return"confirmation"+id.replace("(","_").replace(")","_")};$scope.removeRecipe=
function(_id){Recipe.remove({id:_id},function(){$("#"+$scope.confirmationID(_id)).modal("hide");$timeout(function(){$scope.recipes=Recipe.query()},500)})}})})();(function(){var index=angular.module("index");index.controller("RecipeDetailHopAmountCtrl",function($scope){$scope.$watch("hop.AMOUNT",function(){$scope.amountGrs=$scope.hop.AMOUNT*1E3});$scope.amountGrs=$scope.hop.AMOUNT*1E3});index.controller("RecipeDetailCtrl",function($scope,BrewHelper,BrewCalc,Grain,Hop,HopUse,HopForm,Yeast,Style,Tag,Misc,MiscType,MiscUse,$routeParams,$rootScope,Recipe,$location,alertFactory,TagColor,CalculatorPopup,PrintRecipePopup){$scope.BrewHelper=BrewHelper;$rootScope.breadcrumbs=
[{link:"#",title:"Home"},{link:"#",title:"Receta"}];$scope.color=TagColor;$scope.grains=Grain.query();$scope.hops=Hop.query();$scope.hopUses=HopUse.query();$scope.hopForms=HopForm.query();$scope.yeasts=Yeast.query();$scope.miscs=Misc.query();$scope.styles=Style.query();$scope.miscTypes=MiscType.query();$scope.miscUses=MiscUse.query();$scope.tags=Tag.query();$scope.openCalculatorOG=function(){CalculatorPopup.open({abv:true,hydrometer:false,refractometer:false},{OG:$scope.recipe.OG,FG:$scope.recipe.FG})};
$scope.openCalculatorFG=function(){CalculatorPopup.open({abv:false,hydrometer:false,refractometer:true},{OG:$scope.recipe.OG,FG:$scope.recipe.FG})};$scope.round=function(value){return Math.round(value)};$scope.round1=function(value){return BrewHelper.round(value,10)};$scope.round2=function(value){return BrewHelper.round(value,100)};$scope.removeFermentable=function(fermentable){var index=$scope.recipe["FERMENTABLES"]["FERMENTABLE"].indexOf(fermentable);$scope.recipe["FERMENTABLES"]["FERMENTABLE"].splice(index,
1);$scope.changeAmount()};$scope.addFermentable=function(){$scope.recipe["FERMENTABLES"]["FERMENTABLE"].push({"NAME":"","VERSION":"1","AMOUNT":null,"TYPE":"Grain","YIELD":0,"COLOR":null,"POTENTIAL":null,"PERCENTAGE":100});$scope.changeAmount()};$scope.batchSizeBlur=function(){if((!$scope.recipe.BATCH_SIZE||$scope.recipe.BATCH_SIZE==0)&&$scope.tempAmount)$scope.recipe.BATCH_SIZE=$scope.tempAmount};$scope.tempAmount=null;$scope.noUpdate=false;$scope.$watch("recipe.EFFICIENCY",function(newValue,oldValue){if($scope.disableWatchs||
!oldValue||!$scope.recipe)return;if(!$scope.recipe.fixIngredients||$scope.recipe.fixIngredients=="0"){$scope.noUpdate=true;$scope.recipe.BATCH_SIZE=BrewHelper.round($scope.recipe.BATCH_SIZE*newValue/oldValue,10);$scope.changeAmount()}else $scope.changeAmount()});$scope.$watch("recipe.BATCH_SIZE",function(newValue,oldValue){if($scope.disableWatchs||!oldValue||!$scope.recipe||!$scope.recipe.FERMENTABLES)return;if($scope.noUpdate){$scope.noUpdate=false;return}if(!newValue||newValue==0){$scope.tempAmount=
oldValue;return}if(!$scope.recipe.fixIngredients||$scope.recipe.fixIngredients=="0"){var cohef=newValue/oldValue;var newTotalAmount=$scope.recipe.totalAmount*cohef;angular.forEach($scope.recipe.FERMENTABLES.FERMENTABLE,function(f){f.AMOUNT=BrewHelper.round(f.PERCENTAGE/100*newTotalAmount,1E3)});var newTotalHop=$scope.recipe.totalHop*cohef;angular.forEach($scope.recipe.HOPS.HOP,function(hop){var percentage=$scope.hopPercentage(hop,$scope.recipe.totalHop);hop.AMOUNT=BrewHelper.round(percentage/100*
newTotalHop,1E4)})}$scope.changeAmount()});$scope.changeAmount=function(){var amount=0;angular.forEach($scope.recipe.FERMENTABLES.FERMENTABLE,function(f){amount+=f.AMOUNT});$scope.recipe.totalAmount=amount;angular.forEach($scope.recipe.FERMENTABLES.FERMENTABLE,function(f){f.PERCENTAGE=BrewHelper.round(f.AMOUNT/$scope.recipe.totalAmount*100,100)});var colourMCU=0;angular.forEach($scope.recipe.FERMENTABLES.FERMENTABLE,function(f){colourMCU+=f.AMOUNT/0.45359*f.COLOR/($scope.recipe.BATCH_SIZE*0.264172052637296)});
$scope.recipe.CALCCOLOUR=1.4922*Math.pow(colourMCU,0.6859);var og=0;angular.forEach($scope.recipe.FERMENTABLES.FERMENTABLE,function(f){og+=BrewHelper.toLbs(f.AMOUNT)*BrewHelper.toPpg(f.POTENTIAL)*($scope.recipe.EFFICIENCY/100)/BrewHelper.toGal($scope.recipe.BATCH_SIZE)});$scope.recipe.OG=BrewHelper.toPotential(og);$scope.recipe.StrikeWater=BrewHelper.round($scope.recipe.WatertoGrainRatio*$scope.recipe.totalAmount,10);$scope.changeHop()};$scope.hopGramsPerLiter=function(hop,batchSize){return hop.AMOUNT*
1E3/batchSize};$scope.hopPercentage=function(hop,totalHop){return hop.AMOUNT/totalHop*100};function getUtilization(name,list){var utilization=1;angular.forEach(list,function(it){if(name===it.name)utilization=it.utilization});return utilization}$scope.hopIBU=function(hop){var U=BrewHelper.calculateU($scope.recipe.OG,hop.TIME);var baseIBU=BrewHelper.toOz(hop.AMOUNT)*hop.ALPHA*U*(7489/100)/BrewHelper.toGal($scope.recipe.BATCH_SIZE);return baseIBU*getUtilization(hop.USE,$scope.hopUses)*getUtilization(hop.FORM,
$scope.hopForms)};$scope.copyHop=function(hop){var copy=angular.copy(hop);delete copy._id;$scope.recipe["HOPS"]["HOP"].push(copy);$scope.changeHop()};$scope.removeHop=function(hop){var index=$scope.recipe["HOPS"]["HOP"].indexOf(hop);$scope.recipe["HOPS"]["HOP"].splice(index,1);$scope.changeHop()};$scope.addHop=function(){$scope.recipe["HOPS"]["HOP"].push({"NAME":"","VERSION":"1","ALPHA":null,"AMOUNT":null,"USE":"Boil","TIME":0,"FORM":"Pellet"});$scope.changeHop()};$scope.suggests=[];$scope.changeHop=
function(){var amount=0;var ibu=0;$scope.suggests=[];angular.forEach($scope.recipe.HOPS.HOP,function(hop){amount+=hop.AMOUNT;ibu+=$scope.hopIBU(hop);$scope.suggests.push(hop.NAME)});$scope.recipe.totalHop=amount;$scope.recipe.CALCIBU=BrewHelper.round(ibu,10);$scope.changeYeast()};$scope.changeYeast=function(){var OG=BrewHelper.toPpg($scope.recipe.OG);var FG=OG*(100-$scope.recipe.YEASTS.YEAST[0].ATTENUATION)/100;$scope.recipe.FG=BrewHelper.toPotential(FG);$scope.recipe.ABV=BrewHelper.round((OG-FG)*
0.131,100);var AA=(OG-FG)/OG;var RTE=0.82*FG+0.18*OG;$scope.recipe.BV=BrewHelper.round(0.8*$scope.recipe.CALCIBU/RTE,100)};$scope.convertColor=function(srm){return BrewHelper.convertColor(srm)};$scope.calulateBUGU=function(bu,gu){return bu/BrewHelper.toPpg(gu)};$scope.changeGrain=function(fermentable){angular.forEach($scope.grains,function(grain){if(fermentable.NAME==grain.name){fermentable.POTENTIAL=grain.potential;fermentable.COLOR=grain.colour}});$scope.changeAmount()};$scope.onChangeHop=function(changed){angular.forEach($scope.hops,
function(hop){if(changed.NAME==hop.name)changed.ALPHA=hop.alpha});$scope.changeHop()};$scope.onChangeYeast=function(changed){angular.forEach($scope.yeasts,function(yeast){if(changed.NAME==yeast.name)changed.ATTENUATION=yeast.aa});$scope.changeYeast()};$scope.addMisc=function(){$scope.recipe.MISCS.MISC.push({NAME:null,VERSION:"1",TYPE:"Fining",USE:"Boil",TIME:null,AMOUNT:null})};$scope.onChangeMisc=function(changed){angular.forEach($scope.miscs,function(misc){if(changed.NAME==misc.name){changed.TYPE=
misc.type;changed.USE=misc.use}})};$scope.removeMisc=function(misc){var index=$scope.recipe.MISCS.MISC.indexOf(misc);$scope.recipe.MISCS.MISC.splice(index,1)};$scope.importEnabled=angular.isDefined(window.File)&&angular.isDefined(window.FileReader)&&angular.isDefined(window.FileList)&&angular.isDefined(window.Blob);$scope.notifications=[];$scope.bjcpLink=function(selected){var link;angular.forEach($scope.styles,function(style){if(style.link&&selected==style.name)link=style.link});return link};$scope.relatedLink=
function(selected){var link;angular.forEach($scope.styles,function(style){if(style.link&&selected==style.name)link=style.related});return link};$scope.save=function(){if(!angular.isDefined($scope.recipe.NAME)){$scope.notifications.push({type:"danger",title:"Nombre obligatorio",text:"La receta debe tener un nombre"});alertFactory.create("danger","El nombre debe ser obligatorio")}else{if(!$scope.recipe.$save)$scope.recipe=new Recipe($scope.recipe);$scope.recipe.BOIL_SIZE=$scope.BrewCalc.calculateBoilSize($scope.recipe.BATCH_SIZE,
$scope.recipe.TrubChillerLosses,$scope.recipe.BOIL_TIME,$scope.recipe.PercentEvap,$scope.recipe.TopUpWater);$scope.saving=true;$scope.recipe.$save(function(saved){$scope.saving=false;$scope.notifications.push({type:"success",title:"Receta Guardada!",text:"Ya puedes acceder a esta receta desde cualquier lugar!"});alertFactory.create("success","Receta Guardada!");$location.path("/recipe/edit/"+saved._id)},function(error){if(error.status==501){alertFactory.create("warning",error.data.error,"Cuidado!");
$scope.notifications.push({type:"warning",title:"Cuidado!",text:error.data.error})}else{alertFactory.create("danger",error.data.error);$scope.notifications.push({type:"danger",title:"Error!",text:error.data.error})}})}};$rootScope.$watch("user",function(user){if(user){var now=new Date;if($routeParams.recipeId)$scope.recipe=Recipe.get({id:$routeParams.recipeId},function(){if($location.path().indexOf("/recipe/clone")==0){$scope.recipe.cloneFrom=$scope.recipe._id;$scope.recipe._id=undefined;$scope.recipe.code=
undefined;$scope.recipe.date=now;$scope.recipe.modificationDate=now;$scope.recipe.starredBy=[];$scope.recipe.clonedBy=[];$scope.recipe.isPublic=$scope.user.settings.defaultValues.isPublic;$scope.recipe.comments=[]}BrewCalc.fixEmptyValues($scope.recipe);$scope.changeYeast();$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Receta - "+$scope.recipe.NAME}]});else{$scope.recipe=new Recipe({"GrainCalcMethod":"2",fixIngredients:"1",STYLE:{},date:now,modificationDate:now,totalAmount:0,totalHop:0,
CALCCOLOUR:0,BATCH_SIZE:$scope.user.settings.defaultValues.BATCH_SIZE,EFFICIENCY:$scope.user.settings.defaultValues.EFFICIENCY,OG:1,CALCIBU:0,FG:1,BOIL_TIME:$scope.user.settings.defaultValues.BOIL_TIME,BREWER:$scope.user.settings.defaultValues.BREWER,GrainAbsorbtion:$scope.user.settings.defaultValues.GrainAbsorbtion||0.9,"FERMENTABLES":{"FERMENTABLE":[]},"HOPS":{"HOP":[]},"YEASTS":{"YEAST":[{"NAME":"","VERSION":"1","ATTENUATION":75}]},MISCS:{MISC:[]},fermentation:{view:"expand",stages:[]},bottling:{sugarType:"cane",
bottles:[]},WatertoGrainRatio:$scope.user.settings.defaultValues.WatertoGrainRatio,mashTemp:$scope.user.settings.defaultValues.mashTemp,lossMashTemp:$scope.user.settings.defaultValues.lossMashTemp,GrainTemp:$scope.user.settings.defaultValues.GrainTemp,SpargeDeadSpace:$scope.user.settings.defaultValues.SpargeDeadSpace,SpargeTempDesired:$scope.user.settings.defaultValues.SpargeTempDesired,TopUpWater:0,PercentEvap:$scope.user.settings.defaultValues.PercentEvap,TrubChillerLosses:$scope.user.settings.defaultValues.TrubChillerLosses,
isPublic:$scope.user.settings.defaultValues.isPublic,collaborators:[],version:[]});$scope.changeYeast()}}});$scope.tabLink=function(tab){var base="#/recipe/edit/"+$scope.recipe._id;if(tab=="mash")return base+"/mash";return base};$scope.gravityBarValue=function(grav,max){return BrewHelper.toPpg(grav)/max*100};$scope.volumeByCarbonatationType={sugar:0,must:0,co2:0};$scope.addTag=function($event){if($event.keyCode==13){if(!$scope.recipe.tags)$scope.recipe.tags=[];if($scope.recipe.tags.indexOf($scope.recipe.newTag)==
-1)$scope.recipe.tags.push($scope.recipe.newTag);$scope.recipe.newTag=""}};$scope.bottledLiters=function(){return BrewCalc.bottledLiters($scope.volumeByCarbonatationType,$scope.recipe.bottling.bottles)};$scope.estimateLiters=function($index){return BrewCalc.estimateLiters($index,$scope.recipe.BATCH_SIZE,$scope.recipe.fermentation.stages)};$scope.handleFileSelect=function(file){var files=file.files;for(var i=0,f;f=files[i];i++){var reader=new FileReader;reader.onload=function(theFile){return function(e){var xotree=
new XML.ObjTree;var xml=e.target.result;var tree=xotree.parseXML(xml);var scope=$scope;scope.recipe=tree.RECIPES.RECIPE;scope.recipe.CALCCOLOUR=parseFloat(scope.recipe.CALCCOLOUR);scope.recipe.BATCH_SIZE=parseFloat(scope.recipe.BATCH_SIZE)||$scope.user.settings.defaultValues.BATCH_SIZE;scope.recipe.EFFICIENCY=parseFloat(scope.recipe.EFFICIENCY)||$scope.user.settings.defaultValues.EFFICIENCY;scope.recipe.OG=parseFloat(scope.recipe.OG);scope.recipe.FG=parseFloat(scope.recipe.FG);scope.recipe.CALCIBU=
parseFloat(scope.recipe.CALCIBU);scope.recipe.BOIL_SIZE=parseFloat(scope.recipe.BOIL_SIZE);scope.recipe.BOIL_TIME=parseFloat(scope.recipe.BOIL_TIME)||$scope.user.settings.defaultValues.BOIL_TIME;scope.recipe.PRIMARY_TEMP=parseFloat(scope.recipe.PRIMARY_TEMP);scope.recipe.BREWER=scope.recipe.BREWER||$scope.user.settings.defaultValues.BREWER;scope.recipe.TrubChillerLosses=parseFloat(scope.recipe.TrubChillerLosses)||$scope.user.settings.defaultValues.TrubChillerLosses;scope.recipe.mashTemp=parseFloat(scope.recipe.mashTemp)||
$scope.user.settings.defaultValues.mashTemp;scope.recipe.GrainTemp=parseFloat(scope.recipe.GrainTemp)||$scope.user.settings.defaultValues.GrainTemp;scope.recipe.SpargeTempDesired=parseFloat(scope.recipe.SpargeTempDesired)||$scope.user.settings.defaultValues.SpargeTempDesired;scope.recipe.SpargeDeadSpace=parseFloat(scope.recipe.SpargeDeadSpace)||$scope.user.settings.defaultValues.SpargeDeadSpace;scope.recipe.lossMashTemp=parseFloat(scope.recipe.lossMashTemp)||$scope.user.settings.defaultValues.lossMashTemp;
scope.recipe.PercentEvap=parseFloat(scope.recipe.PercentEvap)||$scope.user.settings.defaultValues.PercentEvap;scope.recipe.WatertoGrainRatio=parseFloat(scope.recipe.WatertoGrainRatio)||$scope.user.settings.defaultValues.WatertoGrainRatio;scope.recipe.StrikeWater=parseFloat(scope.recipe.StrikeWater)||BrewHelper.round(scope.recipe.WatertoGrainRatio*scope.recipe.totalAmount,10);scope.recipe.GrainAbsorbtion=parseFloat(scope.recipe.GrainAbsorbtion)||$scope.user.settings.defaultValues.GrainAbsorbtion||
0.9;scope.recipe.isPublic=$scope.user.settings.defaultValues.isPublic;scope.recipe.TopUpWater=0;scope.recipe.totalAmount=0;function convertFerm(ferm){ferm.AMOUNT=parseFloat(ferm.AMOUNT);ferm.COLOR=parseFloat(ferm.COLOR);ferm.POTENTIAL=parseFloat(ferm.POTENTIAL);ferm.PERCENTAGE=parseFloat(ferm.PERCENTAGE);scope.recipe.totalAmount+=ferm.AMOUNT}if(scope.recipe.FERMENTABLES.FERMENTABLE instanceof Array)angular.forEach(scope.recipe.FERMENTABLES.FERMENTABLE,convertFerm);else{convertFerm(scope.recipe.FERMENTABLES.FERMENTABLE);
scope.recipe.FERMENTABLES.FERMENTABLE=[scope.recipe.FERMENTABLES.FERMENTABLE]}var times=[0,5,10,15,20,25,30,35,40,45,50,55,60,70,80,90,100,110,120];function convertHop(hop){hop.ALPHA=parseFloat(hop.ALPHA);hop.AMOUNT=parseFloat(hop.AMOUNT);hop.TIME=parseFloat(hop.TIME);if(times.indexOf(hop.TIME)==-1){var t=times[0];var i=0;while(t<hop.TIME)t=times[++i];hop.TIME=times[i-1]}scope.recipe.totalHop+=hop.AMOUNT}scope.recipe.totalHop=0;if(scope.recipe.HOPS.HOP instanceof Array)angular.forEach(scope.recipe.HOPS.HOP,
convertHop);else{convertHop(scope.recipe.HOPS.HOP);scope.recipe.HOPS.HOP=[scope.recipe.HOPS.HOP]}function convertMisc(misc){misc.TIME=parseFloat(misc.TIME);misc.AMOUNT=parseFloat(misc.AMOUNT)}if(scope.recipe.MISCS&&scope.recipe.MISCS.MISC)if(scope.recipe.MISCS.MISC instanceof Array)angular.forEach(scope.recipe.MISCS.MISC,convertMisc);else{convertMisc(scope.recipe.MISCS.MISC);scope.recipe.MISCS.MISC=[scope.recipe.MISCS.MISC]}else scope.recipe.MISCS={MISC:[]};scope.recipe.MASH.MASH_STEPS.MASH_STEP=
[];scope.recipe.YEASTS.YEAST=[scope.recipe.YEASTS.YEAST];scope.recipe.YEASTS.YEAST[0].ATTENUATION=parseFloat(scope.recipe.YEASTS.YEAST[0].ATTENUATION);scope.recipe.GrainCalcMethod="2";scope.recipe.fermentation={view:"expand",stages:[]};scope.recipe.bottling={sugarType:"cane",bottles:[]};scope.changeYeast();scope.recipe.date=new Date;scope.disableWatchs=true;scope.$apply();scope.disableWatchs=false}}(f);reader.readAsText(f)}};$scope.printRecipe=function(){PrintRecipePopup.open($scope.recipe)}})})();(function(){var index=angular.module("login",["calculator"]);index.run(function($rootScope){$rootScope.loginSuccess=false});index.controller("LoginController",function($scope,$rootScope,User,Notification,notificationData,pushListener,CalculatorPopup){$scope.openCalcPopup=function(){CalculatorPopup.open()};$scope.$on("g+login",function(event,authResult){if(authResult==null){$rootScope.loginSuccess=true;$scope.loginError="";$rootScope.$apply()}else if(authResult["access_token"]){gapi.auth.setToken(authResult);
gapi.client.load("oauth2","v2",function(){var request=gapi.client.oauth2.userinfo.get();request.execute(function(obj){User.getByGoogleId({id:obj.id,name:obj.name},function(user){$rootScope.loginSuccess=true;$rootScope.user=user;console.log(user)})})})}else if(authResult["error"]=="immediate_failed"){$rootScope.loginSuccess=true;$scope.loginError="";$rootScope.$apply()}else if(authResult["error"]){$rootScope.loginSuccess=true;$scope.loginError=authResult["error"];$scope.$apply();$rootScope.$apply();
console.log("There was an error: "+authResult["error"])}else{$rootScope.loginSuccess=true;$scope.loginError=JSON.stringify(authResult);$scope.$apply();$rootScope.$apply();console.log("Error inesperado")}});$scope.googleSignIn=function(){googleSignIn()};notificationData.listener=function(){$scope.notificationClass="";$scope.notificationCount=0};notificationData.updateListener=function(){$scope.findNotificationsCount()};$scope.notificationClass="";$scope.notificationCount=0;$scope.$watch("user",function(user){if(user){$scope.findNotificationsCount();
pushListener.on("NOTIFICATION_ADD_"+user._id,function(data){console.log("INFO","New Notification (Count)",data);$scope.findNotificationsCount()})}});$scope.findNotificationsCount=function(){console.log("Actualizacion notificaciones");Notification.findNews(function(nots){$scope.notificationCount=nots.length;$scope.notificationClass=nots.length!=0?"gt-notificaction-count-alert":""})}})})();(function(){var comments=angular.module("comments",[]);comments.controller("CommentController",function($scope,Recipe,$filter,$timeout,$interval,pushListener){$scope.rows=1;$scope.loadNewComments=false;$scope.removeComment=function(comment){$("#confirmation-"+comment._id).modal("hide");$timeout(function(){var remove={comment:comment,recipe_id:$scope.recipe._id};Recipe.removeComment(remove)},1*1E3)};$scope.comment_new_id=null;function loadComments(){Recipe.getComments({id:$scope.recipe._id},function(comments){$scope.recipe.comments=
comments})}function onAddComment(data){console.log("INFO","New comment",data);var f=util.Arrays.filter($scope.recipe,data,function(data,iter){return data._id==iter._id?0:-1});if(f.length==0){$scope.recipe.comments.push(data);$scope.$apply()}}function onRemoveComment(removed){console.log("INFO","Remove comment",data);util.Arrays.remove($scope.recipe.comments,removed,function(removed,iter){return removed._id==iter._id?0:-1});$scope.$apply()}$scope.$watch("recipe._id",function(){if($scope.recipe&&$scope.recipe._id){loadComments();
pushListener.on("RECIPE_COMMENT_ADD_"+$scope.recipe._id,onAddComment);pushListener.on("RECIPE_COMMENT_REMOVE_"+$scope.recipe._id,onRemoveComment)}});$scope.$on("$destroy",function(){pushListener.off("RECIPE_COMMENT_ADD_"+$scope.recipe._id,onAddComment);pushListener.off("RECIPE_COMMENT_REMOVE_"+$scope.recipe._id,onRemoveComment)});$scope.addComment=function(comment){var newComment={recipe_id:$scope.recipe._id,text:comment};Recipe.addComment(newComment,function(comments){$scope.comment="";$scope.rows=
1})};$scope.focus=function(comment){$scope.rows=5};$scope.blur=function(comment){if(!comment||comment=="")$scope.rows=1}})})();(function(){var module=angular.module("brew-o-module.controller");module.controller("FermentationCtrl",function($scope){$scope.addFermentationStage=function(){var temp=null;if($scope.recipe.fermentation.stages.length!=0)temp=$scope.recipe.fermentation.stages[$scope.recipe.fermentation.stages.length-1].temperatureEnd;$scope.recipe.fermentation.stages.push({title:null,duration:0,durationMode:"Dias",transferring:false,losses:0,temperature:temp,temperatureEnd:null,action:null})};var today;if($scope.recipe.fermentation.estimateDate)today=
new Date($scope.recipe.fermentation.estimateDate);else today=new Date;$scope.simulatedDate_day=today.getDate();$scope.simulatedDate_month=today.getMonth()+1;$scope.simulatedDate_year=today.getYear()+1900;$scope.$watch("simulatedDate_day+simulatedDate_month+simulatedDate_year",function(value){if($scope.simulatedDate_day&&$scope.simulatedDate_month&&$scope.simulatedDate_year){$scope.recipe.fermentation.estimateDate=new Date($scope.simulatedDate_year,$scope.simulatedDate_month-1,$scope.simulatedDate_day);
var timeFromEstimate=$scope.recipe.fermentation.estimateDate.getTime();var nowTime=(new Date).getTime();for(var i=0;i<$scope.recipe.fermentation.stages.length;i++){var stage=$scope.recipe.fermentation.stages[i];if(stage.alertDone&&timeFromEstimate>nowTime)stage.alertDone=false;if(stage.durationMode&&stage.duration)if(stage.durationMode=="Horas")timeFromEstimate+=stage.duration*1E3*60*60;else timeFromEstimate+=stage.duration*1E3*60*60*24}}});$scope.estimateEnd=function(day,month,year,fermentation){var date=
new Date(year,month-1,day);return new Date(date.getTime()+calculateDays(fermentation)*24*60*60*1E3)};function calculateDays(fermentation){var days=0;angular.forEach(fermentation.stages,function(stage){var duration=stage.duration|0;if(duration!=0){if(stage.durationMode=="Horas")duration=duration/24;days+=duration}});return days}$scope.calculateDays=function(fermentation){var days=calculateDays(fermentation);var round=Math.round(days);var dec=days-round;var hours=Math.round(24*dec);var result=round+
" dias";if(hours!=0)result+=" y "+hours+" horas";return result};$scope.moveUp=function(stage,$index){$scope.recipe.fermentation.stages.splice($index,1);$scope.recipe.fermentation.stages.splice($index-1,0,stage)};$scope.moveDown=function(stage,$index){$scope.recipe.fermentation.stages.splice($index,1);$scope.recipe.fermentation.stages.splice($index+1,0,stage)};$scope.changeTemp=function(stage){if(!angular.isDefined(stage.temperatureEnd)||stage.temperatureEnd==null){stage.temperatureEnd=stage.temperature;
$scope.updateChart()}};$scope.styleTitle=function(onFocus){if(onFocus)return{background:"white","border-color":"#ccc"};else return{background:"#f5f5f5","border-color":"#f5f5f5",cursor:"pointer"}};$scope.updateChart=function(){var cols=[{"id":"day","label":"Dias","type":"date"},{"id":"temp","label":"Temperatura","type":"number"}];var rows=[];var day=0;var today=new Date($scope.simulatedDate_year,$scope.simulatedDate_month-1,$scope.simulatedDate_day);angular.forEach($scope.recipe.fermentation.stages,
function(stage){var duration=stage.duration|0;if(duration!=0){if(stage.durationMode=="Horas")duration=duration/24;rows.push({"c":[{"v":today},{"v":stage.temperature|0,"f":(stage.temperature|0)+"\u00ba (Inicio: "+stage.title+")"}]});day+=duration;today=new Date(today.getTime()+duration*24*60*60*1E3);rows.push({"c":[{"v":today},{"v":stage.temperatureEnd|0,"f":(stage.temperatureEnd|0)+"\u00ba (Fin: "+stage.title+") "+(stage.transferring?" trasvase":"")}]})}else rows.push({"c":[{"v":today},{"v":stage.temperature|
0,"f":(stage.temperature|0)+"\u00ba ("+stage.title+")"+(stage.transferring?" trasvase":"")}]})});$scope.chart.data.cols=cols;$scope.chart.data.rows=rows};$scope.chart={"type":"LineChart","displayed":true,"cssStyle":{height:"300px",width:"100%"},"data":{"cols":[],"rows":[]},"options":{"title":"Evolucion","isStacked":"false","fill":20,"displayExactValues":true,"vAxis":{"title":"Temperatura","gridlines":{"count":10},minValue:0},"hAxis":{"title":"Dias"}},"formatters":{}};$scope.updateChart();$scope.emptyAlert=
function(){if($scope.recipe.fermentation.alertTime=="")delete $scope.recipe.fermentation.alertTime}})})();(function(){var module=angular.module("brew-o-module.controller");module.controller("RecipeLogCtrl",function($scope,BrewCalc,BrewHelper,$timeout){var MASH_TEMP_TIME=40;var COOLING_TIME=30;$scope.discardFilter={discard:false};$scope.isFiltering=true;$scope.toogleRemovedFilter=function(){if($scope.isFiltering){$scope.discardFilter={};$scope.isFiltering=false}else{$scope.discardFilter={discard:false};$scope.isFiltering=true}};$scope.removed=false;$scope.opened=false;$scope.openDp=function(){$timeout(function(){$scope.opened=
true})};$scope.edit=null;$scope.goEdit=function(log){$scope.edit=log};$scope.goNew=function(){var log={time:new Date,delay:0,detail:null,logType:"CUSTOM",discard:false};$scope.recipe.log.logs.push(log);$scope.goEdit(log);updatePendingTime()};$scope.orderLog=function(value){if(value.time instanceof Date)return value.time;else return new Date(value.time)};$scope.now=function(){if($scope.recipe.log.logs.length!=0){for(var i=$scope.recipe.log.logs.length-1;i>=0;i--){var log=$scope.recipe.log.logs[i];
if(log.logType!="CUSTOM"){var time=log.time;if(typeof time=="string")time=new Date(time);return time}}return new Date}else return new Date};var mashFixed=[{delay:0,detail:"Encender Fuego",logType:"START"}];var spargeFixed=[{delay:60,detail:"Comenzar Lavado",logType:"SPARGE"}];var boilFixed=[{delay:120,delayUnit:"m",detail:"Romper Hervor",logType:"BOIL"}];var coolingFixed=[{delay:0,delayUnit:"m",detail:"Apagar fuego y Whirpool",logType:"COOLING"},{delay:10,delayUnit:"m",detail:"Enfriado",logType:"COOLING"}];
function addMinutes(date,minutes){var d=new Date(date.getTime());d.setMinutes(d.getMinutes()+minutes);return d}function prevTime(){if($scope.pendingLogs.length!=0)return $scope.pendingLogs[$scope.pendingLogs.length-1].time();else return $scope.now()}function addFixed(list){for(var i=0;i<list.length;i++){var filter=util.Arrays.filter($scope.recipe.log.logs,function(item){return item.logType==list[i].logType?0:-1});if(filter.length!=0)continue;addPending(list[i].delay,list[i].detail,list[i].logType)}}
function stepAction(STEP){if(STEP.infuse)return"Agregar Agua";else if(STEP.decoction)return"Decoccion";return null}$scope.calculatePending=function(){$scope.pendingLogs=[];addFixed(mashFixed);var delay=MASH_TEMP_TIME;for(var i=0;i<$scope.recipe.MASH.MASH_STEPS.MASH_STEP.length;i++){step=$scope.recipe.MASH.MASH_STEPS.MASH_STEP[i];var filter=util.Arrays.filter($scope.recipe.log.logs,function(item){return item.logType=="MASH_STEP"&&item.logRef==step._id.toString()?0:-1});if(filter.length!=0){delay=step.STEP_TIME;
continue}var name=step.NAME+" - "+step.STEP_TEMP+"\u00baC ";if(step.END_TEMP!=step.STEP_TEMP)name+=" a "+step.END_TEMP+"\u00baC";name+=" - "+step.STEP_TIME+" min";if(stepAction(step))name+=" - "+stepAction(step);if(step.recirculate)name+=" - Recirculando";addPending(delay,name,"MASH_STEP",step._id.toString());delay=step.STEP_TIME}for(var i=0;i<spargeFixed.length;i++){var f=spargeFixed[i];var filter=util.Arrays.filter($scope.recipe.log.logs,function(item){return item.logType==f.logType?0:-1});if(filter.length!=
0){delay=f.delay;continue}addPending(delay,f.detail,f.logType);delay=f.delay}addFixed(boilFixed);var prevDelay=$scope.recipe.BOIL_TIME;for(var i=0;i<$scope.recipe.HOPS.HOP.length;i++){var hop=$scope.recipe.HOPS.HOP[i];var filter=util.Arrays.filter($scope.recipe.log.logs,function(item){return item.logType=="BOIL_HOP"&&item.logRef==hop._id.toString()?0:-1});if(filter.length!=0){prevDelay=hop.TIME;continue}var name=hop.AMOUNT*1E3+"g de "+hop.NAME+" ("+hop.USE+" "+hop.TIME+"')";addPending(prevDelay-hop.TIME,
name,"BOIL_HOP",hop._id.toString());prevDelay=hop.TIME}addFixed(coolingFixed);prevDelay=COOLING_TIME;for(var i=0;i<$scope.recipe.fermentation.stages.length;i++){var stage=$scope.recipe.fermentation.stages[i];var filter=util.Arrays.filter($scope.recipe.log.logs,function(item){return item.logType=="FERM_STAGE"&&item.logRef==stage._id.toString()?0:-1});if(filter.length!=0){prevDelay=convert2Minutes(stage);continue}var name=stage.title+" - "+stage.duration+" "+stage.durationMode;name+=" - "+stage.temperature+
"\u00ba";if(stage.temperature!=stage.temperatureEnd)name+=" a "+stage.temperatureEnd+"\u00ba";addPending(prevDelay,name,"FERM_STAGE",stage._id.toString());prevDelay=convert2Minutes(stage)}for(var i=0;i<$scope.recipe.bottling.bottles.length;i++){var bottle=$scope.recipe.bottling.bottles[i];var filter=util.Arrays.filter($scope.recipe.log.logs,function(item){return item.logType=="BOTTLING"&&item.logRef==bottle._id.toString()?0:-1});if(filter.length!=0){prevDelay=0;continue}var name=bottle.bottleType+
" - "+bottle.amount+" Unidades";addPending(prevDelay,name,"BOTTLING",bottle._id.toString());prevDelay=0}};function convert2Minutes(stage){if(stage.durationMode=="Horas")return stage.duration*60;else if(stage.durationMode=="Dias")return stage.duration*60*24}function addPending(delay,detail,type,ref){$scope.pendingLogs.push({prev:prevTime(),time:function(){return addMinutes(this.prev,this.delay)},delay:delay,detail:detail,logType:type,logRef:ref})}$scope.calculatePending();function updatePendingTime(){if($scope.pendingLogs!=
0){$scope.pendingLogs[0].prev=$scope.now();for(var i=1;i<$scope.pendingLogs.length;i++)$scope.pendingLogs[i].prev=$scope.pendingLogs[i-1].time()}}$scope.$watch("edit.time",function(value){updatePendingTime()});$scope.pushAndEdit=function(log){$scope.push(log);var last=$scope.recipe.log.logs[$scope.recipe.log.logs.length-1];$scope.goEdit(last)};$scope.push=function(log){log.time=new Date;$scope.recipe.log.logs.push({time:new Date,delay:log.delay,detail:log.detail,logType:log.logType,logRef:log.logRef,
discard:false});util.Arrays.remove($scope.pendingLogs,log);updatePendingTime()};$scope.discard=function(log){log.discard=true};$scope.pushAndDiscard=function(log){$scope.push(log);var last=$scope.recipe.log.logs[$scope.recipe.log.logs.length-1];$scope.discard(last)};$scope.restore=function(log){util.Arrays.remove($scope.recipe.log.logs,log);$scope.calculatePending()}})})();(function(){var print=angular.module("print",[]);print.factory("PrintRecipePopup",function($modal){var obj={open:function(recipe){var modalInstance=$modal.open({templateUrl:"partial/print/print-popup.html",controller:function($scope,$modalInstance,recipe){$scope.cancel=function(){$modalInstance.dismiss("cancel")};$scope.print=function(){var mywindow=window.open("","my div");mywindow.document.write("<html><head><title>"+recipe.NAME+"</title>");mywindow.document.write('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
mywindow.document.write('<link rel="stylesheet" href="/css/style.css" type="text/css" />');mywindow.document.write('<link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css" />');mywindow.document.write('<link rel="stylesheet" href="/css/bootstrap-theme.min.css" type="text/css" />');mywindow.document.write("</head><body >");mywindow.document.write(angular.element("#print_content").html());mywindow.document.write("</body></html>");mywindow.print();setTimeout(function(){mywindow.close()},
250)};$scope.fontClass="print-panel-md";$scope.recipe=recipe},windowClass:"modal-lg",resolve:{recipe:function(){return recipe}}});return modalInstance.result}};return obj})})();(function(){var notification=angular.module("notification",[]);notification.factory("notificationData",function(){return{listener:null,reset:function(){if(this.listener)this.listener()},updateListener:null,update:function(){if(this.updateListener)this.updateListener()}}});notification.controller("NotificationsCtrl",function($scope,Notification,$rootScope,notificationData,pushListener){notificationData.reset();$scope.updateCount=function(notifications){$scope.countUnread=0;$scope.countNew=0;angular.forEach(notifications,
function(not){if(not.status=="new")$scope.countNew++;else if(not.status=="unread")$scope.countUnread++})};function onNewNotification(data){console.log("INFO","New Notification (Data)",data);$scope.notifications.splice(0,0,data);$scope.updateCount($scope.notifications)}$scope.$watch("user._id",function(user_id){if(user_id){$scope.notifications=Notification.query($scope.updateCount);pushListener.on("NOTIFICATION_ADD_"+user_id,onNewNotification)}});$scope.$on("$destroy",function(){pushListener.off("NOTIFICATION_ADD_"+
$scope.user._id,onNewNotification)});$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Notificaciones"}];$scope.markAllAsRead=function(){angular.forEach($scope.notifications,function(n){$scope.markAsRead(n,false)});notificationData.reset()};$scope.markAsRead=function(notification,update){function callback(){if(update)notificationData.update()}if(notification.status!="read"){notification.status="read";if(notification.$save)notification.$save(callback);else Notification.save(notification,
callback);$scope.updateCount($scope.notifications)}};$scope.statusClass=function(notification){if(notification.status=="unread")return"gt-notification-unread";else if(notification.status=="new")return"gt-notification-new";return""}})})();(function(){var abm=angular.module("abm",[]);abm.controller("AbmCtrl",function($scope,$rootScope,$routeParams,Grain,Hop,Bottle,Misc,Yeast,Style,sortData){$scope.allConfigs={Style:{data:Style,name:"Estilos",singular:"Estilo",orderBy:"name",pageSize:10,headers:[{field:"name",caption:"Nombre"},{field:"OG_Min",caption:"OG min"},{field:"OG_Max",caption:"OG max"},{field:"FG_Min",caption:"FG min"},{field:"FG_Max",caption:"FG max"},{field:"IBU_Min",caption:"IBU min"},{field:"IBU_Max",caption:"IBU max"},{field:"Colour_Min",
caption:"Color min"},{field:"Colour_Max",caption:"Color max"},{field:"ABV_Min",caption:"%Alc min"},{field:"ABV_Max",caption:"%Alc max"},{field:"co2_min",caption:"CO2 min"},{field:"co2_max",caption:"CO2 max"}]},Yeast:{data:Yeast,name:"Levaduras",singular:"Levadura",orderBy:"name",headers:[{field:"name",caption:"Nombre",width:"70%"},{field:"aa",caption:"Atenuacion",type:"number",width:"20%"}]},Misc:{data:Misc,name:"Miscs",singular:"Misc",orderBy:"name",headers:[{field:"name",caption:"Nombre"},{field:"type",
caption:"Tipo"},{field:"use",caption:"Uso"}]},Bottle:{data:Bottle,name:"Botellas",singular:"Botella",orderBy:"size",headers:[{field:"_id",caption:"ID",width:"25%"},{field:"name",caption:"Nombre",width:"25%"},{field:"size",caption:"Tama\u00f1o",type:"number",step:"0.01",width:"25%"},{field:"colour",caption:"Color",type:"combo",data:["Ambar","Verde","Blanca"],width:"25%"}]},Grain:{data:Grain,name:"Granos",singular:"Grano",orderBy:"name",headers:[{field:"name",caption:"Nombre",width:"50%"},{field:"type",
caption:"Tipo",width:"15%"},{field:"colour",caption:"Color",type:"number",step:0.1,width:"15%"},{field:"potential",caption:"Potencial",type:"number",step:0.0010,width:"15%"}]},Hop:{data:Hop,name:"Lupulos",singular:"Lupulo",orderBy:"name",headers:[{field:"name",caption:"Nombre",width:"70%"},{field:"alpha",caption:"AA%",type:"number",step:0.1,width:"25%"}]}};$scope.entity=$routeParams.entity;$scope.config=$scope.allConfigs[$scope.entity];$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:$scope.config.name}];
$scope.getActiveClass=function(tab){if(tab==$scope.entity)return"active";else return""}})})();(function(){var abm=angular.module("admin",[]);abm.controller("AdminCtrl",function($scope,$rootScope,$routeParams,AdminUser,AdminRecipe,Bottle,$filter,$location,AdminAction,TempDeviceReport,PublishedRecipe){$scope.allConfigs={Action:{data:AdminAction,name:"Acciones",singular:"Accion",canAdd:false,canRemove:false,canEdit:false,orderBy:"date",orderDir:"-",headers:[{field:"date",caption:"Fecha",format:function(value){return $filter("date")(value,"dd-MM-yyyy HH:mm")}},{field:"actionType",caption:"Accion"},
{field:"data",caption:"Datos"},{field:"_id",caption:"ID"}]},User:{data:AdminUser,name:"Usuarios",singular:"Usuario",canAdd:false,canRemove:false,canEdit:false,orderBy:"name",headers:[{field:"name",caption:"Nombre",valueTemplateUrl:"partial/admin/abm-value-user-link.html"},{field:"singInDate",caption:"Entrada",format:function(value){return $filter("date")(value,"dd-MM-yyyy HH:mm")}},{field:"lastLogin",caption:"Ultima vez",format:function(value){return $filter("date")(value,"dd-MM-yyyy HH:mm")}},{field:"_id",
caption:"ID"}]},Recipe:{data:AdminRecipe,name:"Recetas",singular:"Receta",orderBy:"NAME",canAdd:false,canRemove:false,canEdit:false,headers:[{field:"NAME",caption:"Nombre",type:"link",href:function(row){return"/share.html#/"+row._id}},{field:"STYLE.NAME",caption:"Estilo"},{field:"date",caption:"Creacion",width:"10em",format:function(value){return $filter("date")(value,"dd-MM-yyyy")}},{field:"modificationDate",caption:"Modificacion",width:"10em",format:function(value){return $filter("date")(value,
"dd-MM-yyyy")}},{field:"OG",width:"6em",caption:"OG"},{field:"ABV",width:"6em",caption:"%Acl"},{field:"CALCIBU",width:"6em",caption:"IBUs"},{field:"isPublic",caption:"Publica",type:"checkbox"},{field:"BREWER",caption:"Cervecero"},{field:"owner.name",caption:"Due\u00f1o"}]},TempDeviceReport:{data:TempDeviceReport,name:"Temperaturas",singular:"Temperatura",canAdd:true,canRemove:true,canEdit:true,orderBy:"name",headers:[{field:"code",caption:"Codigo"},{field:"timestamp",caption:"Timestamp",type:"number"},
{field:"recipe_id",caption:"Receta"},{field:"source",caption:"Source"},{field:"temperature",caption:"Temp",type:"number",step:0.1},{field:"temperatureExt",caption:"Temp Ext",type:"number",step:0.1},{field:"temperatureDev",caption:"Temp Dev",type:"number",step:0.1},{field:"coldStatus",caption:"Frio"},{field:"heatStatus",caption:"Calor"}]},Stats:{name:"Stats"}};$scope.getActiveClass=function(tab){if(tab==$scope.entity)return"active";else return""};$scope.context={sharedUrl:function(_id){return"http://"+
$location.host()+":"+$location.port()+"/share.html#/"+_id}};$scope.entity=$routeParams.entity||"Stats";$scope.config=$scope.allConfigs[$scope.entity];$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:$scope.config.name}];if($scope.entity=="Stats"){$scope.recipeCount=AdminRecipe.count();$scope.userCount=AdminUser.count();$scope.publicCount=PublishedRecipe.count()}})})();(function(){var calculator=angular.module("calculator",["helper"]);calculator.controller("CalculatorCtrl",function($scope,$rootScope){$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Herramientas"}];$scope.values=$scope.values||{}});calculator.directive("calculatorAbv",function(){return{restrict:"AE",templateUrl:"partial/calculator/calculator-abv.html",controller:function($scope,BrewCalc){$scope.alcohol={OG:$scope.values.OG||1.05,FG:$scope.values.FG||1.01,mode:"ABV"};function updateABV(){if($scope.alcohol.mode==
"ABV")$scope.alcohol.ABV=BrewCalc.calculateABV($scope.alcohol.OG,$scope.alcohol.FG);else if($scope.alcohol.mode=="OG")$scope.alcohol.OG=BrewCalc.calculateOG($scope.alcohol.FG,$scope.alcohol.ABV);else if($scope.alcohol.mode=="FG")$scope.alcohol.FG=BrewCalc.calculateFG($scope.alcohol.OG,$scope.alcohol.ABV);$scope.alcohol.attenuation=BrewCalc.attenuation($scope.alcohol.OG,$scope.alcohol.FG)}$scope.$watch("alcohol.OG+alcohol.FG+alcohol.ABV",function(){$scope.alcohol.OGP=BrewCalc.toPlato($scope.alcohol.OG);
$scope.alcohol.FGP=BrewCalc.toPlato($scope.alcohol.FG);updateABV()});$scope.updateOG=function(){$scope.alcohol.OG=BrewCalc.fromPlato($scope.alcohol.OGP)};$scope.updateFG=function(){$scope.alcohol.FG=BrewCalc.fromPlato($scope.alcohol.FGP)}}}});calculator.directive("calculatorHydro",function(){return{restrict:"AE",templateUrl:"partial/calculator/calculator-hydro.html",controller:function($scope,BrewCalc){$scope.hydrometer={gravity:1.05,reading:25,calibration:15};function updateValue(){$scope.hydrometer.value=
BrewCalc.adjustHydrometer($scope.hydrometer.gravity,$scope.hydrometer.reading,$scope.hydrometer.calibration);$scope.hydrometer.valueP=BrewCalc.toPlato($scope.hydrometer.value)}$scope.$watch("hydrometer.gravity+hydrometer.reading+hydrometer.calibration",function(){$scope.hydrometer.gravityP=BrewCalc.toPlato($scope.hydrometer.gravity);updateValue()});$scope.updateGravity=function(){$scope.hydrometer.gravity=BrewCalc.fromPlato($scope.hydrometer.gravityP)}}}});calculator.directive("calculatorRefract",
function(){return{restrict:"AE",templateUrl:"partial/calculator/calculator-refract.html",controller:function($scope,BrewCalc){$scope.refractometer={OG:$scope.values.OG||1.05,FG:1.025,correction:1};function updateValue(){$scope.refractometer.valueP=BrewCalc.adjustRefractometer($scope.refractometer.OGP,$scope.refractometer.FGP,$scope.refractometer.correction);$scope.refractometer.value=BrewCalc.fromPlato($scope.refractometer.valueP);$scope.refractometer.ABV=BrewCalc.calculateABV($scope.refractometer.OG,
$scope.refractometer.value)}$scope.$watch("refractometer.OG+refractometer.FG+refractometer.correction",function(){$scope.refractometer.OGP=BrewCalc.toPlato($scope.refractometer.OG);$scope.refractometer.FGP=BrewCalc.toPlato($scope.refractometer.FG);updateValue()});$scope.updateOG=function(){$scope.refractometer.OG=BrewCalc.fromPlato($scope.refractometer.OGP)};$scope.updateFG=function(){$scope.refractometer.FG=BrewCalc.fromPlato($scope.refractometer.FGP)}}}});calculator.directive("calculatorDilution",
function(){return{restrict:"AE",templateUrl:"partial/calculator/calculator-dilution.html",controller:function($scope,BrewCalc){$scope.dilution={currentGrav:1.075,currentVol:20,finalGrav:1.05};function updateValue(){$scope.dilution.finalVol=BrewCalc.dilution($scope.dilution.currentGrav,$scope.dilution.currentVol,$scope.dilution.finalGrav)}$scope.$watch("dilution.currentGrav+dilution.currentVol+dilution.finalGrav",function(){$scope.dilution.currentGravP=BrewCalc.toPlato($scope.dilution.currentGrav);
$scope.dilution.finalGravP=BrewCalc.toPlato($scope.dilution.finalGrav);updateValue()});$scope.updateOG=function(){$scope.dilution.currentGrav=BrewCalc.fromPlato($scope.dilution.currentGravP)};$scope.updateFG=function(){$scope.dilution.finalGrav=BrewCalc.fromPlato($scope.dilution.finalGravP)}}}});calculator.factory("CalculatorPopup",function($modal,$rootScope){var obj={open:function(show,values){var scope=$rootScope.$new();scope.show=show||{abv:true,hydrometer:true,refractometer:true,dilution:true};
var count=0;angular.forEach(scope.show,function(value,key){count+=value?1:0});var windowClass="";scope.colClass="col-xs-12";if(count!=1){windowClass="modal-lg";scope.colClass="col-xs-6"}scope.values=values||{};var modalInstance=$modal.open({templateUrl:"partial/calculator/calculator-popup.html",controller:function($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss("cancel")}},windowClass:windowClass,scope:scope});return modalInstance.result}};return obj})})();(function(){var device=angular.module("device",["resources"]);device.controller("DeviceController",function($scope,TempDevice,Recipe){$scope.entity="TempDevice";$scope.config={data:TempDevice,name:"Dispositivos",singular:"Dispositivo",orderBy:"name",headers:[{field:"name",caption:"Nombre"},{field:"code",caption:"Codigo"},{field:"recipe_id",caption:"Receta",type:"combo-object",comboKey:"_id",comboValue:"NAME",data:Recipe.query()}]}})})();(function(){var res=angular.module("resources",[]);res.factory("User",function($resource,$rootScope){var params=function(){return $rootScope.user?$rootScope.user.google_id:null};return $resource("user/:type:id",{google_id:params},{add:{method:"POST",params:{}},getByGoogleId:{method:"GET",params:{type:"google_"},isArray:false},addToFavorites:{method:"PUT",params:{type:"favorite_add"}},removeFromFavorites:{method:"PUT",params:{type:"favorite_drop"}},get:{method:"GET",params:{type:"id_"}},updateSettings:{method:"PUT",
params:{type:"settings"}}})});res.factory("PublishedRecipe",function($resource,$rootScope){var params=function(){return $rootScope.user?$rootScope.user.google_id:null};return $resource("recipe/:operation:id",{google_id:params,id:"@_id"},{query:{method:"GET",params:{operation:"public"},isArray:true},count:{method:"GET",params:{operation:"public_count"},isArray:false}})});res.factory("Recipe",function($resource,$rootScope){var params=function(){return $rootScope.user?$rootScope.user.google_id:null};
return $resource("recipe/:operation:id",{google_id:params,id:"@_id"},{findPublic:{method:"GET",params:{operation:"public"},isArray:true},findCollaborated:{method:"GET",params:{operation:"collaborated"},isArray:true},publish:{method:"POST",params:{operation:"publish_"}},count:{method:"GET",params:{operation:"my_count"},isArray:false},findByUser:{method:"GET",params:{operation:"by_user_"},isArray:true},stats:{method:"GET",params:{operation:"stats"}},addComment:{method:"PUT",params:{operation:"comment"},
isArray:true},getComments:{method:"GET",params:{operation:"comment"},isArray:true},removeComment:{method:"PUT",params:{operation:"remove_comment"},isArray:true}})});res.factory("Notification",function($resource,$rootScope){var params=function(){return $rootScope.user?$rootScope.user.google_id:null};return $resource("notification/:_id",{google_id:params,_id:"@_id"},{findNews:{method:"GET",params:{_id:"news"},isArray:true}})});var services=["Style","Grain","Hop","Yeast","Misc","Bottle","Tag","WaterReport",
"TempDevice","TempDeviceReport"];angular.forEach(services,function(s){res.factory(s,function($resource){return $resource(s[0].toLowerCase()+s.substr(1)+"/:_id",{_id:"@_id"},{})})});var admin=["User","Recipe","Action"];angular.forEach(admin,function(s){res.factory("Admin"+s,function($resource){return $resource("admin/"+s.toLowerCase()+"/:operation:_id",{_id:"@_id"},{count:{method:"GET",params:{operation:"count"},isArray:false}})})})})();(function(exports){function DiffHelper(){var ready;var result;this.excludes=[];function parentArray(parent){return{parent:parent,wrap:function(field){return parent+"["+field+"]"}}}function parentObject(parent){return{parent:parent,wrap:function(field){return parent+"."+field}}}this.compareAll=function(obj1,obj2,parent){for(var i in obj1)if(ready.indexOf(i)==-1){ready.push(i);var p;if(obj1 instanceof Array)p=parentArray("$");else p=parentObject("$");this.compare(obj1,obj2,i,parent||p)}};this.compare=
function(o1,o2,field,parent){var diff=[];if(o1[field]instanceof Date&&o2[field]instanceof Date){if(o1[field].getTime()!=o2[field].getTime())diff=[parent.wrap(field)]}else if(o1[field]instanceof Array&&o2[field]instanceof Array){var helper=new DiffHelper;helper.excludes=this.excludes;diff=helper.diff(o1[field],o2[field],parentArray(parent.wrap(field)))}else if(o1[field]instanceof Object&&o2[field]instanceof Object){var helper=new DiffHelper;helper.excludes=this.excludes;diff=helper.diff(o1[field],
o2[field],parentObject(parent.wrap(field)))}else if(o1[field]!=o2[field])diff=[parent.wrap(field)];for(var i=0;i<diff.length;i++){var fail=false;for(var ri=0;ri<this.excludes.length;ri++){var reg=new RegExp(this.excludes[ri]);var fail=fail||reg.test(diff[i])}if(!fail)result.push(diff[i])}};this.diff=function(obj1,obj2,parent){ready=[];result=[];this.compareAll(obj1,obj2,parent);this.compareAll(obj2,obj1,parent);return result}}exports.diff=function(obj1,obj2,excludes){var helper=new DiffHelper;helper.excludes=
excludes||[];return helper.diff(obj1,obj2)};exports.Arrays={remove:function(array,object,comparator){if(comparator){var index=-1;for(var i=0;i<array.length;i++)if(comparator(object,array[i])==0){index=i;break}if(index!==-1)array.splice(index,1);return index}else{var index=array.indexOf(object);if(index!==-1)array.splice(index,1);return index}},filter:function(array,comparator){var result=[];for(var i=0;i<array.length;i++)if(comparator(array[i])==0)result.push(array[i]);return result}};exports.formatDate=
function(date,defaultFormatter){date=new Date(date);var today=(new Date).getTime()/1E3;var dateSec=date.getTime()/1E3;var diffSec=today-dateSec;if(diffSec<0)if(diffSec>-10)return"Ahora";else if(diffSec>-60)return"En menos de un minuto";else if(diffSec>-(60*60))return"En "+Math.round(-diffSec/60)+" minutos";else if(date.getDate()==(new Date).getDate())return"En "+Math.floor(-diffSec/60/60)+":"+exports.pad(Math.floor(-diffSec/60%60),2)+" Horas";else if(date.getDate()==(new Date).getDate()+1)return"Ma\u00f1ana "+
defaultFormatter(date,"HH:mm");else return defaultFormatter(date,"dd/MM/yyyy HH:mm");else if(diffSec<10)return"Ahora";else if(diffSec<60)return"Hace menos de un minuto";else if(diffSec<60*60)return"Hace "+Math.round(diffSec/60)+" minutos";else if(date.getDate()==(new Date).getDate())return"Hoy"+" hace "+Math.round(diffSec/60/60)+" horas";else if(date.getDate()==(new Date).getDate()-1)return"Ayer "+defaultFormatter(date,"HH:mm");else return defaultFormatter(date,"dd/MM/yyyy HH:mm")};exports.pad=function(value,
zeros){value=value.toString();if(value.length>zeros)return value;else{var result=value;for(var i=0;i<zeros-value.length;i++)result="0"+result;return result}}})(typeof exports==="undefined"?this["util"]={}:exports);(function(exports){function recalculate(hydro,temp,calibration){var tempunit="C";if(tempunit=="F"){temp=fahrenheitToCelsius(temp);calibration=fahrenheitToCelsius(calibration)}var difference=calculateHydrometerCorrection(temp,calibration);var result=rounddecimal(difference+hydro,3);return result}exports.recalculate=recalculate;function isNumber(s){if(s===null)return false;if(s===0)return true;if(s=="")return false;if(isNaN(s))return false;var i;for(i=0;i<s.length;i++){var c=s.charAt(i);if(!(c>="0"&&
c<="9")&&c!=".")return false}return true}function calculateHydrometerCorrection(temp,calibration){temp=parseFloat(temp);calibration=parseFloat(calibration);if(temp<0||temp>71)return 0;if(calibration<10||calibration>24)return 0;var C=[];var delta=[];for(var i=0;i<=71;i++)C[i]=i;var calibrationOffset=15-Math.round(calibration);var difference=0;delta[0]=-9E-4;delta[1]=-9E-4;delta[2]=-9E-4;delta[3]=-9E-4;delta[4]=-9E-4;delta[5]=-9E-4;delta[6]=-8E-4;delta[7]=-8E-4;delta[8]=-7E-4;delta[9]=-7E-4;delta[10]=
-6E-4;delta[11]=-5E-4;delta[12]=-4E-4;delta[13]=-3E-4;delta[14]=-1E-4;delta[15]=0;delta[16]=2E-4;delta[17]=3E-4;delta[18]=5E-4;delta[19]=7E-4;delta[20]=9E-4;delta[21]=0.0011;delta[22]=0.0013;delta[23]=0.0016;delta[24]=0.0018;delta[25]=0.0021;delta[26]=0.0023;delta[27]=0.0026;delta[28]=0.0029;delta[29]=0.0032;delta[30]=0.0035;delta[31]=0.0038;delta[32]=0.0041;delta[33]=0.0044;delta[34]=0.0047;delta[35]=0.0051;delta[36]=0.0054;delta[37]=0.0058;delta[38]=0.0061;delta[39]=0.0065;delta[40]=0.0069;delta[41]=
0.0073;delta[42]=0.0077;delta[43]=0.0081;delta[44]=0.0085;delta[45]=0.0089;delta[46]=0.0093;delta[47]=0.0097;delta[48]=0.0102;delta[49]=0.0106;delta[50]=0.011;delta[51]=0.0114;delta[52]=0.0118;delta[53]=0.0122;delta[54]=0.0126;delta[55]=0.013;delta[56]=0.0135;delta[57]=0.014;delta[58]=0.0145;delta[59]=0.015;delta[60]=0.0155;delta[61]=0.016;delta[62]=0.0165;delta[63]=0.0171;delta[64]=0.0177;delta[65]=0.0183;delta[66]=0.0189;delta[67]=0.0195;delta[68]=0.0201;delta[69]=0.0207;delta[70]=0.0213;delta[71]=
0.0219;delta[72]=0.0225;delta[73]=0.0231;delta[74]=0.0237;delta[75]=0.0243;delta[76]=0.0249;delta[77]=0.0255;delta[78]=0.0261;delta[79]=0.0267;delta[80]=0.0273;for(i=0;i<C.length;i++){if(C[i]==temp){var calibrationOffsetBounded=calibrationOffset;if(i+calibrationOffsetBounded<0)calibrationOffsetBounded=0;difference=delta[i+calibrationOffsetBounded];break}if(temp>=C[i]&&temp<C[i+1]){var calibrationOffsetBounded=calibrationOffset;if(i+calibrationOffsetBounded<0)calibrationOffsetBounded=0;difference=
(delta[i+calibrationOffsetBounded]+delta[i+calibrationOffsetBounded+1])/2;break}}return difference}function rounddecimal(n,places){if(n===null)return false;if(n==="")return false;if(isNaN(n))return false;if(places<0)return false;if(places>10)return false;var rounded=Math.round(n*Math.pow(10,places))/Math.pow(10,places);var decimalPointPosition=(rounded+"").lastIndexOf(".");if(decimalPointPosition==0){rounded="0"+rounded;decimalPointPosition=1}if(places!=0){decimalPointPosition=(rounded+"").lastIndexOf(".");
if(decimalPointPosition==-1||decimalPointPosition==rounded.length-1)rounded+="."}decimalPointPosition=(rounded+"").lastIndexOf(".");var currentPlaces=(rounded+"").length-1-decimalPointPosition;if(currentPlaces<places)for(x=currentPlaces;x<places;x++)rounded+="0";return rounded}function fahrenheitToCelsius(fahrenheit){fahrenheit=parseFloat(fahrenheit);if(fahrenheit==="")return false;if(isNaN(fahrenheit))return false;return 5/9*(fahrenheit-32)}})(typeof exports==="undefined"?this["bfHydrometer"]={}:
exports);
(function(exports){function recalculate(og2,fg2,wortcorrection2){var part2ogunit="brixwri";var part2OGInBrix;var part2OGInSG;if(part2ogunit=="brixwri"){part2OGInBrix=og2/wortcorrection2;part2OGInSG=convertPlatoToGravity(part2OGInBrix)}if(part2ogunit=="plato"){part2OGInBrix=og2;part2OGInSG=convertPlatoToGravity(og2)}if(part2ogunit=="sg"){part2OGInBrix=convertGravityToPlato(og2,10);part2OGInSG=og2}var part2CorrectedFGInBrix=fg2/wortcorrection2;var part2FGInSG=getFGFromBrix(part2OGInBrix,part2CorrectedFGInBrix);var part2FGInBrix=
convertGravityToPlato(part2FGInSG,10);var valueStr=rounddecimal(part2FGInBrix,2)+" \u00baP, "+rounddecimal(part2FGInSG,3);var abw=76.08*(part2OGInSG-part2FGInSG)/(1.775-part2OGInSG);var abv=abw*(part2FGInSG/0.794);return part2FGInBrix}exports.recalculate=recalculate;function updateOGScale(){setVars();if(part2ogunit=="sg")document.calc.txtPart2og.value="1.048";else document.calc.txtPart2og.value="12"}function isNumber(s){if(s===null)return false;if(s===0)return true;if(s=="")return false;if(isNaN(s))return false;
var i;for(i=0;i<s.length;i++){var c=s.charAt(i);if(!(c>="0"&&c<="9")&&c!=".")return false}return true}function rounddecimal(n,places){if(n===null)return false;if(n==="")return false;if(isNaN(n))return false;if(places<0)return false;if(places>10)return false;var rounded=Math.round(n*Math.pow(10,places))/Math.pow(10,places);var decimalPointPosition=(rounded+"").lastIndexOf(".");if(decimalPointPosition==0){rounded="0"+rounded;decimalPointPosition=1}if(places!=0){decimalPointPosition=(rounded+"").lastIndexOf(".");
if(decimalPointPosition==-1||decimalPointPosition==rounded.length-1)rounded+="."}decimalPointPosition=(rounded+"").lastIndexOf(".");var currentPlaces=(rounded+"").length-1-decimalPointPosition;if(currentPlaces<places)for(x=currentPlaces;x<places;x++)rounded+="0";return rounded}function convertPlatoToGravity(plato){return plato/(258.6-plato/258.2*227.1)+1}function convertGravityToPlato(sg,n){if(!n)n=1;var plato=-1*616.868+1111.14*sg-630.272*Math.pow(sg,2)+135.997*Math.pow(sg,3);return rounddecimal(plato,
n)}function getFGFromBrix(brixOg,brixFg){return 1-0.0044993*brixOg+0.011774*brixFg+2.7581E-4*Math.pow(brixOg,2)-0.0012717*Math.pow(brixFg,2)-7.28E-6*Math.pow(brixOg,3)+6.3293E-5*Math.pow(brixFg,3)}function resetform(){document.calc.reset();setVars();recalculate()}})(typeof exports==="undefined"?this["bfRefractometer"]={}:exports);
(function(exports){var currentVolume2=7.5;var currentGravity2=1.035;var targetVolume=5.5;function recalculate(currentVolume,currentGravity,desiredGravity){var newVolume=(currentGravity-1)/(desiredGravity-1)*currentVolume;newVolume=rounddecimal(newVolume,2);if(isNaN(newVolume))newVolume=0;return newVolume}exports.recalculate=recalculate;function recalculate2(){var newGravity=(currentGravity2-1)*(currentVolume2/targetVolume);newGravity=newGravity+1;newGravity=rounddecimal(newGravity,3);if(isNaN(newGravity))newGravity=
0;$("#divNewGravity").html(newGravity);var difference=rounddecimal(newGravity-currentGravity2,3);if(difference>=0)$("#divGravityDifference").html("<span style='color: green;'>"+difference+"</span>");else $("#divGravityDifference").html("<span style='color: red;'>"+difference+"</span>")}function checkInput2(){setVars();if(!isNumber(currentVolume2)){alert("Wort Volume must be a number.");return false}if(currentVolume2<=0){alert("Current Volume must be greater than zero.");return false}if(!isNumber(currentGravity2)){alert("Current Gravity must be a number (format 1.xxx).");
return false}if(currentGravity2<=1){alert("Current Gravity must be greater than 1.00.");return false}if(!isNumber(targetVolume)){alert("Target Volume must be a number.");return false}if(targetVolume<=0){alert("Target Volume must be greater than zero.");return false}return true}function isNumber(s){if(s===null)return false;if(s===0)return true;if(s=="")return false;if(isNaN(s))return false;var i;for(i=0;i<s.length;i++){var c=s.charAt(i);if(!(c>="0"&&c<="9")&&c!=".")return false}return true}function rounddecimal(n,
places){if(n===null)return false;if(n==="")return false;if(isNaN(n))return false;if(places<0)return false;if(places>10)return false;var rounded=Math.round(n*Math.pow(10,places))/Math.pow(10,places);var decimalPointPosition=(rounded+"").lastIndexOf(".");if(decimalPointPosition==0){rounded="0"+rounded;decimalPointPosition=1}if(places!=0){decimalPointPosition=(rounded+"").lastIndexOf(".");if(decimalPointPosition==-1||decimalPointPosition==rounded.length-1)rounded+="."}decimalPointPosition=(rounded+"").lastIndexOf(".");
var currentPlaces=(rounded+"").length-1-decimalPointPosition;if(currentPlaces<places)for(x=currentPlaces;x<places;x++)rounded+="0";return rounded}})(typeof exports==="undefined"?this["bfDilution"]={}:exports);var data=angular.module("data",[]);data.factory("HopForm",function(){return{query:function(){return[{name:"Pellet",utilization:1},{name:"Whole Leaf",utilization:0.9},{name:"Plug",utilization:0.92}]}}});data.factory("HopUse",function(){return{query:function(){return[{name:"Boil",utilization:1},{name:"First Wort",utilization:1.1},{name:"Dry Hop",utilization:0},{name:"Aroma",utilization:0},{name:"Mash",utilization:0.2}]}}});
data.factory("MiscType",function(){return{query:function(){return["Fining","Water Agent","Spice","Other","Herb","Flavor"]}}});data.factory("MiscUse",function(){return{query:function(){return["Boil","Mash","Secondary"]}}});(function(){var settings=angular.module("settings",[]);settings.controller("SettingsWaterDetailCtrl",function($scope,WaterReport,$routeParams,$rootScope,alertFactory,$location){$rootScope.$watch("user",function(user){if(!user)return;if($routeParams.waterId){console.log("INFO","Edit Water report");$scope.water=WaterReport.get({_id:$routeParams.waterId})}else{console.log("INFO","New Water report");$scope.water=new WaterReport({date:new Date,name:"Mi Reporte de agua",owner:$scope.user._id,cations:{},
anions:{}})}});$scope.save=function(){$scope.water.$save(function(saved){alertFactory.create("success","Reporte de agua Guardado!");$location.path("/settings/water/"+saved._id)})}});settings.controller("SettingsWaterCtrl",function($scope,WaterReport,$rootScope,$timeout){$rootScope.$watch("user",function(user){if(user)$scope.reports=WaterReport.query()});$rootScope.breadcrumbs=[{link:"#",title:"Home"},{link:"#",title:"Agua"}];$scope.removeReport=function(report){$("#confirmation"+report._id).modal("hide");
$timeout(function(){report.$remove(function(){$scope.reports=WaterReport.query()})},500)}});settings.controller("UserSettingsCtrl",function($scope,User,$rootScope){$scope.disconnectUser=function(){var revokeUrl="https://accounts.google.com/o/oauth2/revoke?token="+gapi.auth.getToken().access_token;$.ajax({type:"GET",url:revokeUrl,async:false,contentType:"application/json",dataType:"jsonp",success:function(nullResponse){$rootScope.user=undefined;$scope.$apply()},error:function(e){}})};$rootScope.breadcrumbs=
[{link:"#",title:"Home"},{link:"#",title:"Configuracion"}];$scope.notifications=[];$scope.save=function(){User.updateSettings($scope.user,function(){$scope.notifications.push({type:"success",title:"Configuracion guardada!",text:"Tus cambios han sido guardados con exito!"})})}});settings.controller("SettingsTabCtrl",function($scope){$scope.sortTabs=["data"];$scope.tabs={data:{title:"Datos",template:"data"},water:{title:"Ajuste Agua",template:"water"}};$scope.selectedTab="data";$scope.changeTab=function(tab){$scope.selectedTab=
tab;$scope.$parent.notifications=[]}})})();(function(){var water=angular.module("water",["helper"]);water.directive("waterReport",function(){return{restrict:"AE",scope:{water:"&"},templateUrl:"partial/water/water-report.html",controller:function($scope,BrewCalc){$scope.BrewCalc=BrewCalc;$scope.report={};$scope.report.rows=[{cation:{caption:"Calcio(Ca)",name:"calcium",title:"Calcium content can vary depending on the water source.  Calcium content is sometimes reported (as CaCO3) and must be converted to (ppm) by multiplying by 0.401 for use in this program.  If hardness and calcium values are provided in the water report, check the Hardness results shown below and compare to the Hardness shown in the water report.  If they don't closely agree, there may be an error in the input units. Use the calculator below to try converting the calcium concentration to the proper ppm units.  "},
anion:{caption:"Bicarbonato (HCO3)",name:"bicarbonate",title:"Bicarbonate is typically the predominant Alkalinity producer at typical drinking water pH between 6.5 and 10.5.   Bicarbonate is frequently reported (as CaCO3) units.  This must be converted to (ppm) by multiplying by 1.22 for use in this program.   If the report does not balance, check the reporting units and convert as necessary.  Check the alkalinity result below and compare to the alkalinity from the water report.  If they don't match very well, there may be a units error.  Use the calculator below.  "}},
{cation:{caption:"Magnesio (Mg)",name:"magnesium",title:"Magnesium is typically low in most drinking water and is almost always at lower concentration than Calcium.  Magnesium is sometimes reported (as CaCo3) and must be converted to (ppm) by multiplying by 0.243 for use in this program.  If hardness and magnesium values are given in the water report, check the Hardness results shown below and compare to the Hardness shown in the water report.  If they don't closely agree, there may be an error in the input units.  Use the calculator below to try converting the magnesium concentration to proper ppm units."},
anion:{caption:"Carbonato (CO3)",name:"carbonate",title:"Most drinking water supplies typically have a pH of less than 9.  Carbonate ion does not exist in water with pH below 8 and is a minor component in water with its pH between 8 and 9.  Carbonate may be reported in (as CaCO3) units and must be converted to (ppm) by multiplying by 0.60 for use in this program.   If the water supply pH is below 9, Carbonate can be assumed to be Zero with little error.  This is a component that can be ignored if the concentration is unknown."}},
{cation:{caption:"Sodio (Na)",name:"sodium",title:"Sodium content in drinking water is highly variable.  Low to moderate sodium is an important factor in producing good beer.  This is a component that should not be ignored."},anion:{caption:"Sulfato (SO4)",name:"sulfate",title:"Sulfate is an important flavor component in brewing water.  If the water report result is presented in (SO4-S) units, that value must be multiplied by 3 for use in this program.  Use the calculator."}},{cation:{caption:"Potasion (K)",
name:"potassium",title:"Potassium is typically low in most drinking water.  If the Potassium content is unknown, enter Zero.  This is a water component that can be ignored for most water sources."},anion:{caption:"Cloruros (Cl)",name:"chloride",title:"Chloride is an important flavor component in brewing water.  It is not the same as Chlorine.  Do not enter Chlorine concentration here.  Chlorine is a common water disinfectant and typically ranges from about 1 to 3 ppm in most municipal water supplies.   Chloride concentration is typically much higher than that."}},
{cation:{caption:"Hierro (Fe)",name:"iron",title:"Iron is typically at low concentration (<0.3 ppm) in good brewing water.  Iron greater than this concentration may be tasted in the water and beer.  If the Iron concentration is not known, enter Zero.  This is a water component that can be ignored in this input table if its concentration is not known."},anion:{caption:"Nitratos (NO3)",name:"nitrate",title:"Nitrate is typically low in most drinking water.  If the result is presented in (NO3-N) units, it must be multiplied by 4.43 for use in this program.  Enter Zero if this concentration is not known.  This is a component that can be ignored if its concentration is unknown. Nitrate should typically be less than 10 ppm for potable water."}},
{cation:{},anion:{caption:"Nitritos (NO2)",name:"nitrite",title:"Nitrite is typically low in most drinking water.  Enter Zero if this concentration is not known.  This is a component that can be ignored if its concentration is unknown."}},{cation:{},anion:{caption:"Fluor (F)",name:"fluoride",title:"Fluoride is typically at low concentrations in drinking water.  Enter Zero if the concentration is not known.  This is a component that can be ignored if its concentration is unknown."}}]}}})})();(function(){var env=angular.module("env",[]);env.constant("version","1.0.1-RC1");env.constant("env","1.0.1-RC1");env.constant("color","danger")})();if(typeof XML=="undefined")XML=function(){};XML.ObjTree=function(){return this};XML.ObjTree.VERSION="0.24";XML.ObjTree.prototype.xmlDecl='<?xml version="1.0" encoding="UTF-8" ?>\n';XML.ObjTree.prototype.attr_prefix="-";XML.ObjTree.prototype.overrideMimeType="text/xml";
XML.ObjTree.prototype.parseXML=function(xml){var root;if(window.DOMParser){var xmldom=new DOMParser;var dom=xmldom.parseFromString(xml,"application/xml");if(!dom)return;root=dom.documentElement}else if(window.ActiveXObject){xmldom=new ActiveXObject("Microsoft.XMLDOM");xmldom.async=false;xmldom.loadXML(xml);root=xmldom.documentElement}if(!root)return;return this.parseDOM(root)};
XML.ObjTree.prototype.parseHTTP=function(url,options,callback){var myopt={};for(var key in options)myopt[key]=options[key];if(!myopt.method)if(typeof myopt.postBody=="undefined"&&typeof myopt.postbody=="undefined"&&typeof myopt.parameters=="undefined")myopt.method="get";else myopt.method="post";if(callback){myopt.asynchronous=true;var __this=this;var __func=callback;var __save=myopt.onComplete;myopt.onComplete=function(trans){var tree;if(trans&&trans.responseXML&&trans.responseXML.documentElement)tree=
__this.parseDOM(trans.responseXML.documentElement);else if(trans&&trans.responseText)tree=__this.parseXML(trans.responseText);__func(tree,trans);if(__save)__save(trans)}}else myopt.asynchronous=false;var trans;if(typeof HTTP!="undefined"&&HTTP.Request){myopt.uri=url;var req=new HTTP.Request(myopt);if(req)trans=req.transport}else if(typeof Ajax!="undefined"&&Ajax.Request){var req=new Ajax.Request(url,myopt);if(req)trans=req.transport}if(callback)return trans;if(trans&&trans.responseXML&&trans.responseXML.documentElement)return this.parseDOM(trans.responseXML.documentElement);
else if(trans&&trans.responseText)return this.parseXML(trans.responseText)};XML.ObjTree.prototype.parseDOM=function(root){if(!root)return;this.__force_array={};if(this.force_array)for(var i=0;i<this.force_array.length;i++)this.__force_array[this.force_array[i]]=1;var json=this.parseElement(root);if(this.__force_array[root.nodeName])json=[json];if(root.nodeType!=11){var tmp={};tmp[root.nodeName]=json;json=tmp}return json};
XML.ObjTree.prototype.parseElement=function(elem){if(elem.nodeType==7)return;if(elem.nodeType==3||elem.nodeType==4){var bool=elem.nodeValue.match(/[^\x00-\x20]/);if(bool==null)return;return elem.nodeValue}var retval;var cnt={};if(elem.attributes&&elem.attributes.length){retval={};for(var i=0;i<elem.attributes.length;i++){var key=elem.attributes[i].nodeName;if(typeof key!="string")continue;var val=elem.attributes[i].nodeValue;if(!val)continue;key=this.attr_prefix+key;if(typeof cnt[key]=="undefined")cnt[key]=
0;cnt[key]++;this.addNode(retval,key,cnt[key],val)}}if(elem.childNodes&&elem.childNodes.length){var textonly=true;if(retval)textonly=false;for(var i=0;i<elem.childNodes.length&&textonly;i++){var ntype=elem.childNodes[i].nodeType;if(ntype==3||ntype==4)continue;textonly=false}if(textonly){if(!retval)retval="";for(var i=0;i<elem.childNodes.length;i++)retval+=elem.childNodes[i].nodeValue}else{if(!retval)retval={};for(var i=0;i<elem.childNodes.length;i++){var key=elem.childNodes[i].nodeName;if(typeof key!=
"string")continue;var val=this.parseElement(elem.childNodes[i]);if(!val)continue;if(typeof cnt[key]=="undefined")cnt[key]=0;cnt[key]++;this.addNode(retval,key,cnt[key],val)}}}return retval};XML.ObjTree.prototype.addNode=function(hash,key,cnts,val){if(this.__force_array[key]){if(cnts==1)hash[key]=[];hash[key][hash[key].length]=val}else if(cnts==1)hash[key]=val;else if(cnts==2)hash[key]=[hash[key],val];else hash[key][hash[key].length]=val};
XML.ObjTree.prototype.writeXML=function(tree){var xml=this.hash_to_xml(null,tree);return this.xmlDecl+xml};
XML.ObjTree.prototype.hash_to_xml=function(name,tree){var elem=[];var attr=[];for(var key in tree){if(!tree.hasOwnProperty(key))continue;var val=tree[key];if(key.charAt(0)!=this.attr_prefix)if(typeof val=="undefined"||val==null)elem[elem.length]="<"+key+" />";else if(typeof val=="object"&&val.constructor==Array)elem[elem.length]=this.array_to_xml(key,val);else if(typeof val=="object")elem[elem.length]=this.hash_to_xml(key,val);else elem[elem.length]=this.scalar_to_xml(key,val);else attr[attr.length]=
" "+key.substring(1)+'="'+this.xml_escape(val)+'"'}var jattr=attr.join("");var jelem=elem.join("");if(typeof name=="undefined"||name==null);else if(elem.length>0)if(jelem.match(/\n/))jelem="<"+name+jattr+">\n"+jelem+"</"+name+">\n";else jelem="<"+name+jattr+">"+jelem+"</"+name+">\n";else jelem="<"+name+jattr+" />\n";return jelem};
XML.ObjTree.prototype.array_to_xml=function(name,array){var out=[];for(var i=0;i<array.length;i++){var val=array[i];if(typeof val=="undefined"||val==null)out[out.length]="<"+name+" />";else if(typeof val=="object"&&val.constructor==Array)out[out.length]=this.array_to_xml(name,val);else if(typeof val=="object")out[out.length]=this.hash_to_xml(name,val);else out[out.length]=this.scalar_to_xml(name,val)}return out.join("")};
XML.ObjTree.prototype.scalar_to_xml=function(name,text){if(name=="#text")return this.xml_escape(text);else return"<"+name+">"+this.xml_escape(text)+"</"+name+">\n"};XML.ObjTree.prototype.xml_escape=function(text){return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};(function(){var gt=angular.module("gt.abm",[]);gt.constant("PAGE_SIZE",10);function getValue(entity,field){var value;if(field.indexOf(".")!=-1){var chain=field.split(".");for(var i=0;i<chain.length;i++)if(entity)entity=entity[chain[i]];value=entity||"-"}else value=entity[field];return value}gt.filter("pageFilter",function(PAGE_SIZE){return function(rows,page,pageSize){var from=(page-1)*(pageSize||PAGE_SIZE);var to=from+(pageSize||PAGE_SIZE);return rows.slice(from,to)}});function convert(value,ic){if(ic)return value.toLowerCase();
else return value}var fixedFilters={equal:function(fieldName,value,ic){return function(item){return convert(getValue(item,fieldName),ic)==convert(value,ic)?0:-1}},like:function(fieldName,value,ic){return function(item){var patt=new RegExp(".*"+convert(value,ic)+".*");return patt.exec(convert(getValue(item,fieldName),ic))!=null?0:-1}},searchIn:function(fieldName,value,ic,type){return function(item){if(!type||type=="value")return value.indexOf(getValue(item,fieldName))!=-1?0:-1;else{var list=getValue(item,
fieldName);var ret=0;angular.forEach(value,function(l){if(list.indexOf(l)==-1)ret=-1});return ret}}}};gt.filter("textFilter",function($filter,$timeout){return function(rows,criteria){return $filter("filter")(rows,criteria)}});gt.filter("advanced",function(){return function(rows,filterData){if(!rows)return rows;if(!filterData)return rows;else{var filters=[];angular.forEach(filterData,function(filter,field){if(filter.type!="list"&&filter.value||filter.type=="list"&&filter.value&&filter.value.length!=
0){var f=fixedFilters[filter.comparator](field,filter.value,filter.ignoreCase,filter.type);filters.push(f)}});angular.forEach(filters,function(f){rows=util.Arrays.filter(rows,f)});return rows}}});gt.run(function($templateCache,abm){$templateCache.put(abm.templateDir+"/abm-checkbox.html",'<div class="checkbox" style="margin-bottom: 0;">'+'<input type="checkbox" ng-model="value[header.field]" />'+"</div>");$templateCache.put(abm.templateDir+"/abm-value.html",'<span ng-class="header.class(row)">{{getValue(row,header)}}</span>');
$templateCache.put(abm.templateDir+"/abm-link.html",'<a href="{{header.href(row)}}" ng-class="header.class(row)">'+"{{getValue(row,header)}}"+"</a>")});gt.directive("gtTable",function($compile,$rootScope,sortData,PAGE_SIZE,abm){return{restrict:"EA",replace:true,scope:{config:"&",entity:"&",canRemove:"=",canEdit:"=",canAdd:"=",context:"&",filterData:"=",searchCriteria:"=?"},templateUrl:abm.templateDir+"/abm.html",link:function(scope,element,attrs){},controller:function($scope,$timeout){$scope.emptyResultText=
$scope.config().emptyResultText||"La busqueda no ha devuelto ningun resultado";$scope.searchCriteria=$scope.searchCriteria||"";$scope._searchCriteria=$scope.searchCriteria;var activeTimeout=null;$scope.search=function(){if(activeTimeout)$timeout.cancel(activeTimeout);activeTimeout=$timeout(function(){$scope.searchCriteria=$scope._searchCriteria},500)};$scope.clearSearch=function(){$scope.searchCriteria="";$scope._searchCriteria=""};$scope.sort=sortData($scope.config().orderBy,$scope.config().orderDir||
"",$scope.config().sort);$scope.getActiveClass=function(tab){if(tab==$scope.entity())return"active";else return""};$scope.urlTemplate=function(filter){return abm.templateDir+"/abm-filter-"+filter.type+".html"};$scope.getHeaderStyle=function(header){var style=header.headerStyle||{};if(header.width)style.width=header.width;return style};$scope.addNew=function(){$scope.rows.push({_draft:true});$scope.page=$scope.getPageCount($scope.rows.length)};$scope.edit_id=null;$scope.isEditing=function(row){return row._id==
$scope.edit_id};$scope.valueTemplate=function(row,header){if($scope.isEditing(row)&&!header.readonly)if(!header.type||header.type=="text"||header.type=="number")return abm.templateDir+"/abm-input.html";else if(header.type=="checkbox")return abm.templateDir+"/abm-checkbox.html";else if(header.type=="combo")return abm.templateDir+"/abm-combo.html";else if(header.type=="combo-object")return abm.templateDir+"/abm-combo-object.html";else return abm.templateDir+"/abm-input.html";else if(header.valueTemplateUrl)return header.valueTemplateUrl;
else if(header.type=="checkbox")return abm.templateDir+"/abm-value-checkbox.html";else if(header.type=="link")return abm.templateDir+"/abm-link.html";else return abm.templateDir+"/abm-value.html"};$scope.edit=function(row){$scope.edit_id=row._id};$scope.copy=function(row){return angular.copy(row)};$scope.getValue=function(entity,header){var value;if(header.field.indexOf(".")!=-1){var chain=header.field.split(".");for(var i=0;i<chain.length;i++)if(entity)entity=entity[chain[i]];value=entity||"-"}else value=
entity[header.field];if(header.format)return header.format(value);else return value};$scope.remove=function(row){var clean=function(){util.Arrays.remove($scope.rows,row)};if(!row.$delete)$scope.config().data.remove(row,clean);else row.$delete(clean)};$scope.cancel=function(row,value){if(row._draft)util.Arrays.remove($scope.rows,row);else angular.forEach($scope.config().headers,function(h){value[h.field]=row[h.field]});$scope.edit_id=null};$scope.save=function(value,row){angular.forEach($scope.config().headers,
function(h){row[h.field]=value[h.field]});if(row._id){if(!row.$save)$scope.config().data.save(row);else row.$save();$scope.edit_id=null}else $scope.config().data.save(row,function(n){row._id=n._id})};$scope.loading=true;$scope.page=1;$scope.rows=$scope.config().data.query(function(){$scope.loading=false});$scope.pageSize=function(){return $scope.config().pageSize||PAGE_SIZE};$scope.getPageCount=function(length){var pageSize=$scope.pageSize();return Math.ceil(length/pageSize)}}}});gt.provider("abm",
function(){var service={templateDir:"abm"};this.setTemplateDir=function(dir){service.templateDir=dir};this.$get=function(){return service}});gt.factory("sortData",function(){return function(startField,startAsc,startSort){var data={sort:startSort,asc:startAsc,field:startField,orderStyle:{},orderBy:function(){if(this.sort)return this.sort;else return this.field},reverse:function(){return this.asc||this.asc=="-"},resort:function(field,sort){if(field==this.field)if(this.asc=="-"){this.asc="";this.orderStyle[field]=
"glyphicon glyphicon-chevron-up"}else{this.asc="-";this.orderStyle[field]="glyphicon glyphicon-chevron-down"}else{angular.forEach(this.orderStyle,function(style,key){data.orderStyle[key]=""});this.orderStyle[field]="glyphicon glyphicon-chevron-up";this.sort=sort;this.field=field;this.asc=""}}};if(startAsc=="-")data.orderStyle[startField]="glyphicon glyphicon-chevron-down";else data.orderStyle[startField]="glyphicon glyphicon-chevron-up";return data}})})();(function(){var observer=angular.module("observer",[]);observer.run(function($location,pushListener){pushListener.socket=io.connect("http://"+$location.host())});observer.factory("pushListener",function(){return{on:function(id,callback){this.socket.on(id,callback)},off:function(id,fn){if(fn)this.socket.removeListener(id,fn);else this.socket.removeAllListeners(id)}}})})();
