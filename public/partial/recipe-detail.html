<div class="panel panel-default" id="RecipeDetailCtrl">
    <div class="panel-body">
        <div class="row">
            <div class="col-lg-4">
                <label for="recipename">Nombre</label>
                <input type="text" class="form-control" id="recipename" placeholder="Nombre" ng-model="recipe.NAME">
            </div>
            <div class="col-lg-2">
              <label for="batch_size">Batch (L)</label>
              <input ng-change="changeAmount()" type="number" class="form-control" id="batch_size" step="0.1" ng-model="recipe.BATCH_SIZE">
            </div>
            <div class="col-lg-2">
              <label for="OG">OG</label>
              <input type="number" class="form-control" id="OG" ng-model="recipe.OG" step="0.001" disabled>
            </div>
            <div class="col-lg-2">
              <label for="ibu">IBU</label>
              <input type="text" class="form-control" id="ibu" readonly="true" ng-model="recipe.CALCIBU">
            </div>
            <div class="col-lg-2">
              <label for="balance">Balance</label>
              <input type="text" class="form-control" id="balance" readonly="true" ng-model="recipe.BV"/>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4">
                <label for="style">Style</label>
                <input type="text" class="form-control" id="style" placeholder="Estilo" ng-model="recipe.STYLE.NAME">
            </div>
            <div class="col-lg-2">
              <label for="EFFICIENCY">Eficiencia</label>
              <input ng-change="changeAmount()" type="number" class="form-control" id="EFFICIENCY" ng-model="recipe.EFFICIENCY">
            </div>
            <div class="col-lg-2">
              <label for="fg">FG</label>
              <input type="text" class="form-control" id="fg" readonly="true" ng-model="recipe.FG"/>
            </div>
            <div class="col-lg-2">
              <label for="bugu">BU/GU</label>
              <input type="text" class="form-control" id="bugu" readonly="true" value="{{calulateBUGU(recipe.CALCIBU,recipe.OG)|number:2}}"/>
            </div>
            <div class="col-lg-2">
              <label for="abv">Alcohol (ABV) %</label>
              <input type="text" class="form-control" id="abv" readonly="true" ng-model="recipe.ABV"/>
            </div>
        </div>
    </div>
</div>
<ng-include src="'partial/recipe-detail-fermentables.html'"></ng-include>
<ng-include src="'partial/recipe-detail-hops.html'"></ng-include>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Levadura</strong></div>
    <table class="table table-condensed table-hover">
      <thead>
        <tr>
          <th style="width:90%">Levadura</th>
          <th style="width:10%">Atenuacion</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="yeast in recipe.YEASTS.YEAST">
            <!--<td><input class="form-control input-sm" type="text" ng-model="yeast.NAME"/></td>-->
            <td>
                <input ng-change="onChangeYeast(yeast)" class="form-control input-sm" type="text" ng-model="yeast.NAME" list="yeastNames" placeholder="Buscar Levaduras"/>
                <datalist id="yeastNames">
                    <option ng-repeat="yeast in yeasts" value="{{yeast.name}}">
                        {{yeast.name}}
                    </option>
                </datalist>
            </td>
            <td><input ng-change="changeYeast()" class="form-control input-sm" type="number" ng-model="yeast.ATTENUATION"/></td>
        </tr>
      </tbody>
    </table>
</div>
<div class="panel panel-default">
    <div class="panel-heading">Misc</div>
    <div class="panel-body">
        
    </div>
</div>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Otros datos</strong></div>
    <div class="panel-body" >
        <div class="row">
            <div class="col-lg-6">
                <label for="brewer">Cervecero</label>
                <input type="text" class="form-control" id="brewer" placeholder="Cervecero" ng-model="recipe.BREWER">
            </div>
            <div class="col-lg-2">
              <label for="boil_size">Litros a Hervir (L)</label>
              <input type="number" class="form-control" id="boil_size" step="0.1" ng-model="recipe.BOIL_SIZE">
            </div>
            <div class="col-lg-2">
              <label for="boil_time">Tiempo Hervido (min)</label>
              <input type="number" class="form-control" id="boil_time" ng-model="recipe.BOIL_TIME">
            </div>
            <div class="col-lg-2">
              <label for="primary_temp">T. Primario</label>
              <input type="number" class="form-control" id="primary_temp" step="0.1" ng-model="recipe.PRIMARY_TEMP">
            </div>
        </div>
    </div>
</div>
<div style="overflow: hidden;margin-bottom: 1em;">
    <div class="pull-left">
        <a href="#/recipe/" type="button" class="btn btn-link glyphicon glyphicon-chevron-left"> Volver al listado</a>
    </div>
    <div class="pull-right">
        <a href="#/recipe/" type="button" class="btn btn-default">Cancelar</a>
        <button ng-click="save()" type="button" class="btn btn-primary">Guardar</button>
    </div>
</div>
<div ng-repeat="notification in notifications">
    <div class="alert alert-{{notification.type}} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
        <strong>{{notification.title}}</strong>
        {{notification.text}}
    </div>
</div>


<a ng-click="import=true" class="btn btn-link" ng-hide="import">Importar receta desde BrewMate</a>
<div class="panel panel-default" ng-show="import">
    <div class="panel-heading">Importar receta desde BrewMate</div>
    <div class="panel-body" ng-show="importEnabled">
        <input class="form-control input-sm" type="file" id="file" name="files[]" />
    </div>
    <div class="panel-body" ng-hide="importEnabled">
        The File APIs are not fully supported in this browser.    
    </div>
    <script>
        function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object

        // files is a FileList of File objects. List some properties.
        for (var i = 0, f; f = files[i]; i++) {
          var reader = new FileReader();
          reader.onload = (function(theFile) {
            return function(e) {
              // Render thumbnail.
                var xotree = new XML.ObjTree();
                var xml = e.target.result;
                var tree = xotree.parseXML( xml );       	// source to tree
                
                var scope = angular.element(document.getElementById('RecipeDetailCtrl')).scope();
                scope.recipe = tree.RECIPES.RECIPE;
                scope.recipe.CALCCOLOUR = parseFloat(scope.recipe.CALCCOLOUR);
                scope.recipe.BATCH_SIZE = parseFloat(scope.recipe.BATCH_SIZE);
                scope.recipe.EFFICIENCY = parseFloat(scope.recipe.EFFICIENCY);
                scope.recipe.OG = parseFloat(scope.recipe.OG);
                scope.recipe.FG = parseFloat(scope.recipe.FG);
                scope.recipe.CALCIBU = parseFloat(scope.recipe.CALCIBU);
                scope.recipe.BOIL_SIZE = parseFloat(scope.recipe.BOIL_SIZE);
                scope.recipe.BOIL_TIME = parseFloat(scope.recipe.BOIL_TIME);
                scope.recipe.PRIMARY_TEMP = parseFloat(scope.recipe.PRIMARY_TEMP);
                
                scope.recipe.totalAmount = 0;
                function convertFerm(ferm) {
                    ferm.AMOUNT = parseFloat(ferm.AMOUNT);
                    ferm.COLOR = parseFloat(ferm.COLOR);
                    ferm.POTENTIAL = parseFloat(ferm.POTENTIAL);
                    ferm.PERCENTAGE = parseFloat(ferm.PERCENTAGE);
                    scope.recipe.totalAmount += ferm.AMOUNT;
                }
                if (scope.recipe.FERMENTABLES.FERMENTABLE instanceof Array) {
                    angular.forEach(scope.recipe.FERMENTABLES.FERMENTABLE,convertFerm); 
                } else {
                    convertFerm(scope.recipe.FERMENTABLES.FERMENTABLE);
                    scope.recipe.FERMENTABLES.FERMENTABLE = [scope.recipe.FERMENTABLES.FERMENTABLE];
                }
                
                function convertHop(hop) {
                    hop.ALPHA = parseFloat(hop.ALPHA);
                    hop.AMOUNT = parseFloat(hop.AMOUNT);
                    hop.TIME = parseFloat(hop.TIME);
                    scope.recipe.totalHop += hop.AMOUNT;
                }
                scope.recipe.totalHop = 0;
                if (scope.recipe.HOPS.HOP instanceof Array) {
                    angular.forEach(scope.recipe.HOPS.HOP,convertHop);
                } else {
                    convertHop(scope.recipe.HOPS.HOP);
                    scope.recipe.HOPS.HOP = [scope.recipe.HOPS.HOP];
                }
                
                scope.recipe.YEASTS.YEAST = [scope.recipe.YEASTS.YEAST];
                scope.recipe.YEASTS.YEAST[0].ATTENUATION = parseFloat(scope.recipe.YEASTS.YEAST[0].ATTENUATION);
                scope.changeYeast();
                scope.recipe.date = new Date();
                scope.$apply();
                
            };
          })(f);
          reader.readAsText(f);
        }
    }
    document.getElementById('file').addEventListener('change', handleFileSelect, false);
    </script>
</div>
